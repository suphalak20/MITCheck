<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MITCheck - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏ß‡∏¢ GPS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Sarabun', sans-serif; }
    .status-present { background-color: #16a34a !important; color: white !important; }
    .status-absent  { background-color: #dc2626 !important; color: white !important; }
    .status-gps     { background-color: #6213a9 !important; color: white !important; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    .mit-purple { background-color: #6213a9; }
    .mit-gold   { background-color: #fac903; }
    .mit-green  { background-color: #16a34a; }
    .mit-red    { background-color: #dc2626; }
    .text-mit-purple { color: #6213a9; }
    .text-mit-gold   { color: #fac903; }
    .border-mit-purple { border-color: #6213a9; }
    .auto-result {
      background: linear-gradient(135deg, #6213a9, #8b5cf6);
      color: white; padding: 20px; border-radius: 12px; margin: 20px 0;
      box-shadow: 0 4px 15px rgba(98, 19, 169, 0.3);
    }
    .data-persistence {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white; padding: 15px; border-radius: 8px; margin: 10px 0;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-t-4 border-mit-purple">
      <div class="text-center">
        <h1 class="text-4xl font-bold text-mit-purple mb-2">üéì MITCheck</h1>
        <p class="text-lg text-gray-700 font-medium">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏ß‡∏¢ GPS</p>
        <p class="text-sm text-gray-600">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏° - ‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</p>
      </div>

      <!-- Data Persistence Status -->
      <div class="data-persistence text-center mt-4">
        <p class="text-sm">üíæ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</p>
      </div>

      <!-- Navigation -->
      <div class="flex flex-wrap justify-center gap-2 mt-4">
        <button onclick="showPage('manage')" class="nav-btn mit-green text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all font-medium">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
        <button onclick="showPage('departments')" class="nav-btn mit-purple text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all font-medium">üè´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</button>
        <button onclick="showPage('daily')" class="nav-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
        <button onclick="showPage('summary')" class="nav-btn mit-purple text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all font-medium">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°</button>
        <button onclick="showPage('activity')" class="nav-btn bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition-colors font-medium">üéüÔ∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏¢‡∏®.</button>
        <button onclick="showPage('settings')" class="nav-btn bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors font-medium">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets</button>
      </div>
    </div>

    <!-- GPS Status -->
    <div id="gpsStatus" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4 rounded hidden">
      <p class="text-yellow-700">üåç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...</p>
    </div>

    <!-- ================= Departments Page (Dropdown version) ================= -->
    <div id="departmentsPage" class="page">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- ... ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ ... -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üìä ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('accounting', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üíº ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('management', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üì± ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('digital', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üíª ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('it', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">‚öΩ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('sports', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üéØ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('marketing', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>
      </div>
    </div>
    <!-- ================= /Departments Page ================= -->

    <!-- Activity Page -->
    <div id="activityPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üéüÔ∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏¢‡∏®. ‚Äî ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h2>

        <!-- Admin Add Activity -->
        <div class="bg-gray-50 rounded-lg p-6 mb-8">
          <h3 class="text-lg font-semibold mb-4">üë©‚Äçüíº ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input id="actName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" class="border border-gray-300 rounded-lg px-3 py-2">
            <input id="actCapacity" type="number" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö (‡∏Ñ‡∏ô)" class="border border-gray-300 rounded-lg px-3 py-2">
            <button onclick="addActivity()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
          </div>
          <p class="text-sm text-gray-500 mt-2">* ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ</p>
        </div>

        <!-- Activity List -->
        <div>
          <h3 class="text-lg font-semibold mb-3">üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</h3>
          <div id="activityList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Registration Box -->
        <div id="registrationBox" class="mt-8 hidden">
          <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: <span id="regActTitle" class="font-bold"></span></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input id="regFullname" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="border border-gray-300 rounded-lg px-3 py-2">
              <input id="regStudentId" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" class="border border-gray-300 rounded-lg px-3 py-2">
              <select id="regYear" class="border border-gray-300 rounded-lg px-3 py-2">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option>
                <option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option>
                <option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
              </select>
              <select id="regDept" class="border border-gray-300 rounded-lg px-3 py-2">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                <option value="accounting">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                <option value="management">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
                <option value="digital">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
                <option value="it">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
                <option value="sports">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</option>
                <option value="marketing">‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
              </select>
              <input id="regPhoto" type="file" accept="image/*" class="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2">
            </div>

            <div class="mt-4 flex flex-wrap gap-3">
              <button onclick="captureGPSForRegistration()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">üìç ‡∏î‡∏∂‡∏á GPS</button>
              <span id="regGPS" class="text-sm text-gray-700 self-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</span>
            </div>

            <div class="mt-6">
              <button onclick="saveRegistration()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <button onclick="cancelRegistration()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 ml-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Check-in Page -->
    <div id="checkinPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-800" id="checkinTitle">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
            <p class="text-gray-600" id="checkinSubtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
          </div>
          <button onclick="showPage('departments')" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="attendanceDate" class="border border-gray-300 rounded-lg px-3 py-2" onchange="loadAttendanceData()">
        </div>

        <div id="gpsInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <p class="text-blue-800">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentLocation">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
        </div>

        <div id="studentList" class="space-y-3 mb-6"></div>

        <div class="text-center space-y-3">
          <button onclick="saveAttendance()" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors text-lg font-semibold">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <br>
          <button onclick="sendToGoogleSheets()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">üìä ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets</button>
        </div>

        <div id="saveResult" class="mt-4 hidden">
          <div class="auto-result text-center">
            <div class="text-2xl mb-3">üéâ</div>
            <h3 class="text-xl font-bold mb-4">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                <p class="font-bold text-lg">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>
              </div>
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                <p class="font-bold text-lg" id="attendancePercentage">üìä 0%</p>
              </div>
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p>
                <p class="font-bold text-lg" id="checkTime">‚è∞ --:-- ‡∏ô.</p>
              </div>
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</p>
                <p class="font-bold text-lg" id="gpsCoordinates">üìç ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</p>
              </div>
            </div>
            <div class="mt-4 bg-white bg-opacity-20 rounded-lg p-3">
              <p class="text-sm opacity-90">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
              <p class="font-bold" id="dailySummary">‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° 0 ‡∏Ñ‡∏ô ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 0 ‡∏Ñ‡∏ô</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Manage Students Page -->
    <div id="managePage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>

        <div class="bg-gray-50 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="newStudentId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" class="border border-gray-300 rounded-lg px-3 py-2">
            <input type="text" id="newStudentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="border border-gray-300 rounded-lg px-3 py-2">
            <select id="newStudentDept" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
              <option value="accounting">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
              <option value="management">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
              <option value="digital">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
              <option value="it">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
              <option value="sports">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</option>
              <option value="marketing">‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
            </select>
            <select id="newStudentYear" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option>
              <option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option>
              <option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
            </select>
          </div>
          <button onclick="addStudent()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
        </div>

        <div id="manageStudentList"></div>
      </div>
    </div>

    <!-- Daily Report Page -->
    <div id="dailyPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="reportDate" class="border border-gray-300 rounded-lg px-3 py-2" onchange="loadDailyReport()">
        </div>
        <div id="dailyReportContent"></div>
      </div>
    </div>

    <!-- Summary Report Page -->
    <div id="summaryPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°</h2>
        <div id="summaryReportContent"></div>
      </div>
    </div>

    <!-- Behavior Notes Page -->
    <div id="behaviorPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h2>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="behaviorDate" class="border border-gray-300 rounded-lg px-3 py-2" onchange="loadBehaviorNotes()">
        </div>

        <div id="behaviorNotesContent"></div>
      </div>
    </div>

    <!-- Google Sheets Settings Page -->
    <div id="settingsPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">üîó Web App URL:</label>
            <input type="url" id="webAppUrl" placeholder="https://script.google.com/macros/s/YOUR_ID/exec"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2"
                   value="">
            <p class="text-xs text-gray-500 mt-1">URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Web App</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">üìä Google Sheets ID:</label>
            <input type="text" id="sheetsId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2"
                   value="">
            <p class="text-xs text-gray-500 mt-1">ID ‡∏Ç‡∏≠‡∏á Google Sheets (‡∏à‡∏≤‡∏Å URL)</p>
          </div>
        </div>

        <div class="mt-6 flex space-x-4">
          <button onclick="saveGoogleSheetsConfig()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
          <button onclick="testGoogleSheetsConnection()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        </div>

        <div id="connectionStatus" class="mt-4 hidden"></div>
      </div>
    </div>
  </div><!-- /container -->

  <script>
/* ========= 0) CONFIG + HELPERS ========= */
const DEFAULT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwSF0ndVoU5hJrRw4ea5xGcu6tlUifsn4nXtEoay-xpR3AmWRsfQRSOGa0Hp2pPpEZh/exec";
const DEFAULT_SHEETS_ID  = "1ST0Pe4mojfQiWQRR589BTXj0mWqfRorMAsJFKWs89Pc";

let googleSheetsConfig = { webAppUrl: DEFAULT_WEBAPP_URL, sheetsId: DEFAULT_SHEETS_ID };

/** POST ‡πÅ‡∏ö‡∏ö FormData (field: payload) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î preflight/CORS ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á GAS */
async function safePost(url, payload = {}) {
  const fd = new FormData();
  fd.append('payload', JSON.stringify(payload));
  const res  = await fetch(url, { method: 'POST', body: fd });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error(`HTTP ${res.status} ${res.statusText}: ${text?.slice(0,200)||'(empty)'}`); }
}

/* ========= 1) GLOBAL STATE ========= */
let currentDepartment = '';
let currentYear = '';
let currentLocation = null;

let studentsData = {};
let attendanceData = {};
let behaviorNotes = {};

let activitiesData = {};      // { actId: { id, name, capacity, createdAt } }
let registrationsData = {};   // { actId: [ ... ] }
let currentActivityId = null;

/* ========= 2) PERSISTENCE (LOCALSTORAGE) ========= */
function saveToLocalStorage() {
  const data = {
    students: studentsData,
    attendance: attendanceData,
    behavior: behaviorNotes,
    activities: activitiesData,
    registrations: registrationsData,
    lastUpdated: new Date().toISOString()
  };
  localStorage.setItem('mitcheck_data', JSON.stringify(data));
}
function loadFromLocalStorage() {
  const saved = localStorage.getItem('mitcheck_data');
  if (!saved) return false;
  try {
    const data = JSON.parse(saved);
    studentsData      = data.students || {};
    attendanceData    = data.attendance || {};
    behaviorNotes     = data.behavior || {};
    activitiesData    = data.activities || {};
    registrationsData = data.registrations || {};
    showDataLoadedMessage(data.lastUpdated);
    return true;
  } catch { return false; }
}
function showDataLoadedMessage(lastUpdated) {
  if (!lastUpdated) return;
  const date = new Date(lastUpdated);
  const formattedDate = date.toLocaleDateString('th-TH', {
    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
  });
  const messageDiv = document.createElement('div');
  messageDiv.className = 'data-persistence text-center mb-4';
  messageDiv.innerHTML = `<p class="text-sm">üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formattedDate}</p>`;
  const container = document.querySelector('.container');
  container.insertBefore(messageDiv, container.children[1]);
  setTimeout(() => { messageDiv.remove(); }, 5000);
}
function clearAllData() {
  if (!confirm('‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠/‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)')) return;
  localStorage.removeItem('mitcheck_data');
  studentsData = {}; attendanceData = {}; behaviorNotes = {};
  activitiesData = {}; registrationsData = {};
  alert('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä');
  location.reload();
}

/* ========= 3) GPS ========= */
function getLocation() {
  document.getElementById('gpsStatus')?.classList.remove('hidden');
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        currentLocation = { latitude: position.coords.latitude, longitude: position.coords.longitude };
        const el = document.getElementById('currentLocation');
        if (el) el.textContent = `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
        document.getElementById('gpsStatus')?.classList.add('hidden');
      },
      () => {
        const el = document.getElementById('currentLocation');
        if (el) el.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
        document.getElementById('gpsStatus')?.classList.add('hidden');
        currentLocation = { latitude: 17.4138, longitude: 104.7734 }; // fallback
      }
    );
  } else {
    const el = document.getElementById('currentLocation');
    if (el) el.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS';
    document.getElementById('gpsStatus')?.classList.add('hidden');
    currentLocation = { latitude: 17.4138, longitude: 104.7734 };
  }
}

/* ========= 4) NAVIGATION ========= */
function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.getElementById(pageId + 'Page')?.classList.remove('hidden');
  if (pageId === 'manage')      loadManageStudents();
  else if (pageId === 'daily')  loadDailyReport();
  else if (pageId === 'summary')loadSummaryReport();
  else if (pageId === 'behavior')loadBehaviorNotes();
  else if (pageId === 'settings')loadGoogleSheetsConfig();
  else if (pageId === 'activity')loadActivitiesPage();
}
function showCheckIn(department, year) {
  currentDepartment = department;
  currentYear = year;
  const deptNames = {
    accounting: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', management: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', digital: '‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
    it: '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®', sports: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤', marketing: '‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î'
  };
  document.getElementById('checkinTitle').textContent =
    `‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ${deptNames[department]} ‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${year}`;
  document.getElementById('checkinSubtitle').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤`;
  showPage('checkin');
  getLocation();
  loadStudentList();
}

/* ========= 5) STUDENTS / ATTENDANCE UI ========= */
function loadStudentList() {
  const key = `${currentDepartment}-${currentYear}`;
  const students = studentsData[key] || [];
  const studentListDiv = document.getElementById('studentList');
  studentListDiv.innerHTML = '';

  students.forEach(student => {
    const row = document.createElement('div');
    row.className = 'student-row bg-gray-50 rounded-lg p-4 border border-gray-200';
    row.id = `student-${student.id}`;
    row.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="text-4xl">${student.photo || 'üë§'}</div>
          <div>
            <h3 class="font-semibold text-gray-800">${student.name}</h3>
            <p class="text-sm text-gray-600">${student.id}</p>
          </div>
        </div>
        <div class="flex space-x-2">
          <button onclick="setStatus('${student.id}', 'present')" class="status-btn bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors">‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
          <button onclick="setStatus('${student.id}', 'absent')"  class="status-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors">‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
          <button onclick="setStatus('${student.id}', 'gps')"     class="status-btn bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 transition-colors">üìç ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        </div>
      </div>`;
    studentListDiv.appendChild(row);
  });
}
function setStatus(studentId, status) {
  const studentRow = document.getElementById(`student-${studentId}`);
  const date = document.getElementById('attendanceDate').value;
  studentRow.classList.remove('status-present', 'status-absent', 'status-gps');
  studentRow.classList.add(`status-${status}`);
  if (!attendanceData[date]) attendanceData[date] = {};
  attendanceData[date][studentId] = {
    status,
    timestamp: new Date().toLocaleString('th-TH'),
    location: currentLocation,
    department: currentDepartment,
    year: currentYear
  };
}
function saveAttendance() {
  const date = document.getElementById('attendanceDate').value;
  const dayData = attendanceData[date] || {};
  const key = `${currentDepartment}-${currentYear}`;
  const students = studentsData[key] || [];

  let present = 0, absent = 0, gps = 0, total = students.length;
  students.forEach(s => {
    if (dayData[s.id]) {
      const st = dayData[s.id].status;
      if (st === 'present') present++;
      else if (st === 'absent') absent++;
      else if (st === 'gps') gps++;
    }
  });

  const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
  const currentTime = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });

  document.getElementById('attendancePercentage').textContent = `üìä ${percentage}%`;
  document.getElementById('checkTime').textContent = `‚è∞ ${currentTime} ‡∏ô.`;
  if (currentLocation) {
    const lat = currentLocation.latitude.toFixed(4);
    const lng = currentLocation.longitude.toFixed(4);
    document.getElementById('gpsCoordinates').textContent = `üìç ${lat}, ${lng} (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢)`;
  }
  document.getElementById('dailySummary').textContent =
    `‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ${present} ‡∏Ñ‡∏ô ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏Ñ‡∏ô (‡∏Ç‡∏≤‡∏î ${absent} ‡∏Ñ‡∏ô, ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î ${gps} ‡∏Ñ‡∏ô)`;

  saveToLocalStorage();
  const box = document.getElementById('saveResult');
  box.classList.remove('hidden');
  setTimeout(() => box.classList.add('hidden'), 8000);
}

/* ========= 6) MANAGE STUDENTS ========= */
/* (‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: addStudent, loadManageStudents, removeStudent) */

/* ========= 7) REPORTS ========= */
/* (‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) */

/* ========= 8) BEHAVIOR NOTES ========= */
/* (‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) */

/* ========= 9) GOOGLE SHEETS CONFIG + STATUS ========= */
function loadGoogleSheetsConfig() {
  const saved = localStorage.getItem('mitcheck_google_config');
  if (saved) {
    try {
      const cfg = JSON.parse(saved);
      googleSheetsConfig = {
        webAppUrl: cfg.webAppUrl || googleSheetsConfig.webAppUrl,
        sheetsId:  cfg.sheetsId  || googleSheetsConfig.sheetsId
      };
    } catch {}
  }
  const urlEl = document.getElementById('webAppUrl');
  const idEl  = document.getElementById('sheetsId');
  if (urlEl) urlEl.value = googleSheetsConfig.webAppUrl || '';
  if (idEl)  idEl.value  = googleSheetsConfig.sheetsId || '';
}
function saveGoogleSheetsConfig() {
  const webAppUrl = document.getElementById('webAppUrl').value.trim();
  const sheetsId  = document.getElementById('sheetsId').value.trim();
  if (!webAppUrl || !sheetsId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Web App URL ‡πÅ‡∏•‡∏∞ Sheets ID ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  googleSheetsConfig = { webAppUrl, sheetsId };
  localStorage.setItem('mitcheck_google_config', JSON.stringify(googleSheetsConfig));
  showConnectionStatus('success', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}
function showConnectionStatus(type, message) {
  const status = document.getElementById('connectionStatus');
  if (!status) return;
  status.classList.remove('hidden');
  const color = type==='success' ? ['bg-green-100','border-green-400','text-green-700']
              : type==='error'   ? ['bg-red-100','border-red-400','text-red-700']
              : ['bg-blue-100','border-blue-400','text-blue-700'];
  status.className = `mt-4 p-4 rounded-lg border ${color.join(' ')}`;
  status.innerHTML = message;
  if (type !== 'loading') setTimeout(()=>status.classList.add('hidden'), 5000);
}
function testGoogleSheetsConnection() {
  if (!googleSheetsConfig.webAppUrl) return alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL ‡∏Å‡πà‡∏≠‡∏ô');
  showConnectionStatus('loading', 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
  const testData = {
    records: [{
      date: new Date().toISOString().split('T')[0],
      time: new Date().toLocaleTimeString('th-TH'),
      studentId: 'TEST001',
      studentName: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
      department: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
      year: '1',
      status: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
      gps: '17.4138, 104.7734'
    }]
  };
  safePost(googleSheetsConfig.webAppUrl, testData)
    .then(data => {
      if (data.success) showConnectionStatus('success', `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.message || ''}`);
      else showConnectionStatus('error', `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error || 'Unknown error'}`);
    })
    .catch(err => showConnectionStatus('error', `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ${err.message}`));
}
async function pingSheetsHealth() {
  if (!googleSheetsConfig.webAppUrl) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL'); return; }
  try {
    const res = await fetch(googleSheetsConfig.webAppUrl + '?action=ping'); // ‡∏ñ‡πâ‡∏≤ GAS ‡∏°‡∏µ pingSheets/doGet routing
    const txt = await res.text();
    alert('Ping result:\n' + txt.slice(0, 400));
  } catch (e) {
    alert('Ping failed: ' + e.message);
  }
}

function sendToGoogleSheets() {
  if (!googleSheetsConfig.webAppUrl) {
    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets ‡∏Å‡πà‡∏≠‡∏ô\n‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets"');
    return;
  }
  const date = document.getElementById('attendanceDate').value;
  const dayData = attendanceData[date] || {};
  if (Object.keys(dayData).length === 0) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');

  const deptNames = {
    'accounting': '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ','management': '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£','digital': '‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
    'it': '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®','sports': '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤','marketing': '‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î'
  };
  const statusNames = { 'present': '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°','absent': '‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°','gps': '‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î' };

  const records = [];
  Object.keys(dayData).forEach(studentId => {
    const record = dayData[studentId];
    const key = `${record.department}-${record.year}`;
    const student = studentsData[key]?.find(s => s.id === studentId);
    if (!student) return;
    const gpsText = record.location
      ? `${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}`
      : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    records.push({
      date,
      time: record.timestamp.split(' ')[1] || new Date().toLocaleTimeString('th-TH'),
      studentId,
      studentName: student.name,
      department: deptNames[record.department] || record.department,
      year: record.year,
      status: statusNames[record.status] || record.status,
      gps: gpsText
    });
  });

  if (!records.length) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á');

  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  loadingDiv.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets...';
  document.body.appendChild(loadingDiv);

  safePost(googleSheetsConfig.webAppUrl, { records })
    .then(data => {
      loadingDiv.remove();
      if (!data.success) throw new Error(data.error || 'Unknown error');

      const successDiv = document.createElement('div');
      successDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      successDiv.innerHTML = `
        <div class="text-center">
          <div class="text-2xl mb-2">üéâ</div>
          <div class="font-bold">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
          <div class="text-sm mt-1">${data.message || ''}</div>
        </div>`;
      document.body.appendChild(successDiv);
      setTimeout(() => successDiv.remove(), 5000);

      if (googleSheetsConfig.sheetsId) {
        const sheetsUrl = `https://docs.google.com/spreadsheets/d/${googleSheetsConfig.sheetsId}/edit`;
        window.open(sheetsUrl, '_blank', 'noopener,noreferrer');
      }
    })
    .catch(err => {
      loadingDiv.remove();
      const errorDiv = document.createElement('div');
      errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      errorDiv.innerHTML = `
        <div class="text-center">
          <div class="text-2xl mb-2">‚ùå</div>
          <div class="font-bold">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
          <div class="text-sm mt-1">${err.message}</div>
          <div class="text-xs mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        </div>`;
      document.body.appendChild(errorDiv);
      setTimeout(() => errorDiv.remove(), 8000);
    });
}
function exportRegistrations(actId) {
  if (!googleSheetsConfig.webAppUrl) {
    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets ‡∏Å‡πà‡∏≠‡∏ô\n‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets"');
    return;
  }
  const act  = activitiesData[actId];
  const regs = registrationsData[actId] || [];
  if (!act) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ');
  if (!regs.length) return alert('‚ùå ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');

  const records = regs.map(r => {
    const d = new Date(r.ts || Date.now());
    const date = d.toISOString().split('T')[0];
    const time = d.toLocaleTimeString('th-TH');
    return {
      date, time,
      studentId: r.studentId,
      studentName: r.fullname,
      department: r.dept,
      year: r.year,
      status: `‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${act.name}`,
      gps: r.gps || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
    };
  });

  const toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  toast.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ Google Sheets...';
  document.body.appendChild(toast);

  safePost(googleSheetsConfig.webAppUrl, { type: 'registrations', records })
    .then(data => {
      toast.remove();
      if (!data.success) throw new Error(data.error || 'Unknown error');

      const ok = document.createElement('div');
      ok.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      ok.innerHTML = `
        <div class="text-center">
          <div class="text-2xl mb-1">üéâ</div>
          <div class="font-bold">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
          <div class="text-sm mt-1">${data.message || ''}</div>
        </div>`;
      document.body.appendChild(ok);
      setTimeout(() => ok.remove(), 6000);

      if (googleSheetsConfig.sheetsId) {
        const url = `https://docs.google.com/spreadsheets/d/${googleSheetsConfig.sheetsId}/edit#gid=0`;
        window.open(url, '_blank', 'noopener,noreferrer');
      }
    })
    .catch(err => {
      toast.remove();
      const bad = document.createElement('div');
      bad.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      bad.innerHTML = `
        <div class="text-center">
          <div class="text-2xl mb-1">‚ùå</div>
          <div class="font-bold">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
          <div class="text-sm mt-1">${err.message}</div>
          <div class="text-xs mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        </div>`;
      document.body.appendChild(bad);
      setTimeout(() => bad.remove(), 8000);
    });
}

/* ========= 12) ACTIVITIES (CRUD + SERVER SYNC) ========= */
async function addActivity() {
  const name = document.getElementById('actName').value.trim();
  const capacity = parseInt(document.getElementById('actCapacity').value, 10);
  if (!name || !capacity || capacity < 1) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  if (!googleSheetsConfig.webAppUrl) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL');

  const toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  toast.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...';
  document.body.appendChild(toast);

  try {
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ù‡∏±‡πà‡∏á GAS ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ type:'createactivity' ‡∏´‡∏£‡∏∑‡∏≠ 'addactivity' ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏∏‡∏ì
    const res = await safePost(googleSheetsConfig.webAppUrl, { type:'addactivity', name, capacity });
    toast.remove();
    if (!res.success) throw new Error(res.error || 'create failed');

    const id = res.id || ('act_' + Math.random().toString(36).slice(2,10));
    activitiesData[id] = { id, name, capacity, createdAt: new Date().toISOString() };
    saveToLocalStorage();

    alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    document.getElementById('actName').value = '';
    document.getElementById('actCapacity').value = '';
    loadActivitiesPage();
  } catch (err) {
    toast.remove();
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
  }
}

async function loadActivitiesPage() {
  const list = document.getElementById('activityList');
  list.innerHTML = '<div class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‚Ä¶</div>';

  try {
    const res = await safePost(googleSheetsConfig.webAppUrl, { type:'listactivities' });
    if (res.success && Array.isArray(res.data)) {
      activitiesData = {};
      res.data.forEach(a => {
        activitiesData[a.id] = {
          id:a.id, name:a.name, capacity:Number(a.capacity||0),
          createdAt:a.createdAt || new Date().toISOString()
        };
      });
      saveToLocalStorage();
    }
  } catch(e) {
    console.warn('listactivities failed:', e.message);
  }

  // render from cache
  list.innerHTML = '';
  const ids = Object.keys(activitiesData);
  if (!ids.length) {
    list.innerHTML = '<div class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</div>';
    return;
  }

  ids.forEach(id => {
    const act  = activitiesData[id];
    const regs = registrationsData[id] || [];
    const remaining = Math.max(0, (act.capacity||0) - regs.length);
    const card = document.createElement('div');
    card.className = 'bg-white rounded-lg border p-4 flex flex-col act-row';
    card.id = `act-${id}`;
    card.innerHTML = `
      <div class="flex-1">
        <h4 class="font-semibold text-gray-800">${act.name}</h4>
        <p class="text-sm text-gray-600 mt-1">
          ‡∏£‡∏±‡∏ö: ${act.capacity} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${regs.length}
          ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="${remaining>0?'text-green-700':'text-red-700'} font-semibold">${remaining}</span>
        </p>
        <p class="text-xs text-gray-500 mt-1">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(act.createdAt).toLocaleString('th-TH')}</p>
      </div>
      <div class="mt-3 flex gap-2">
        <button ${remaining===0?'disabled':''}
          onclick="selectActivity('${id}')"
          class="px-4 py-2 rounded-lg text-white ${remaining===0?'bg-gray-400 cursor-not-allowed':'bg-indigo-600 hover:bg-indigo-700'}">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button onclick="exportRegistrations('${id}')" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">üì§ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ Google Sheets</button>
        <button data-del="${id}" onclick="deleteActivity('${id}', '${act.name.replace(/'/g, "\\'")}')" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">üóëÔ∏è ‡∏•‡∏ö</button>
      </div>`;
    list.appendChild(card);
  });
}

/* ===== NEW: ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡πà‡∏≤‡∏ô safePost ‚Üí type:'deleteactivity' ===== */
async function deleteActivity(actId, actName) {
  if (!actId) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'); return; }
  if (!googleSheetsConfig.webAppUrl) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL'); return; }
  if (!confirm(`‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‚Äú${actName || actId}‚Äù ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?`)) return;

  const btn = document.querySelector(`[data-del="${actId}"]`);
  if (btn) { btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...'; }

  try {
    // ‡∏™‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏î GAS ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
    const payload = {
      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà
      type: 'deleteactivity',
      id: actId,
      activityId: actId,
      actId: actId,
      key: actId,
      // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ù‡∏±‡πà‡∏á GAS ‡∏¢‡∏≠‡∏°‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠
      name: actName
    };

    // ‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡πÅ‡∏ö‡∏ö type ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡∏Å‡πà‡∏≠‡∏ô
    let res = await safePost(googleSheetsConfig.webAppUrl, payload);

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ no records ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á type ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö camelCase ‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
    if ((!res?.success && /no\s*records/i.test(res?.error || '')) || res?.code === 'NO_RECORDS') {
      payload.type = 'deleteActivity';
      res = await safePost(googleSheetsConfig.webAppUrl, payload);
    }

    if (!res?.success) throw new Error(res?.error || 'delete failed');

    // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å cache ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    delete activitiesData[actId];
    delete registrationsData[actId];
    saveToLocalStorage();

    // ‡πÄ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM
    (document.getElementById(`act-${actId}`) || btn?.closest('.act-row'))?.remove();

    alert(res.message || '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  } catch (err) {
    alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    console.error('deleteActivity error:', err);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'üóëÔ∏è ‡∏•‡∏ö'; }
  }
}

function selectActivity(id) {
  currentActivityId = id;
  document.getElementById('regActTitle').textContent = activitiesData[id]?.name || '';
  document.getElementById('registrationBox').classList.remove('hidden');
  document.getElementById('regFullname').value = '';
  document.getElementById('regStudentId').value = '';
  document.getElementById('regYear').value = '';
  document.getElementById('regDept').value = '';
  document.getElementById('regPhoto').value = '';
  document.getElementById('regGPS').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î';
  delete document.getElementById('regGPS').dataset.gps;
}

/* ========= 13) REGISTRATION (FORM) ========= */
function fileToDataURL(file) {
  return new Promise((resolve) => {
    if (!file) return resolve(null);
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.readAsDataURL(file);
  });
}
function captureGPSForRegistration() {
  const label = document.getElementById('regGPS');
  label.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...';
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        label.textContent = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat}, ${lng}`;
        label.dataset.gps = `${lat}, ${lng}`;
      },
      () => {
        label.textContent = '‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ demo: 17.4138, 104.7734)';
        label.dataset.gps = '17.413800, 104.773400';
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  } else {
    label.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ demo: 17.4138, 104.7734)';
    label.dataset.gps = '17.413800, 104.773400';
  }
}
async function saveRegistration() {
  if (!currentActivityId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡πà‡∏≠‡∏ô');

  const fullname  = document.getElementById('regFullname').value.trim();
  const studentId = document.getElementById('regStudentId').value.trim();
  const year      = document.getElementById('regYear').value;
  const dept      = document.getElementById('regDept').value;
  const gpsLabel  = document.getElementById('regGPS');
  const gps       = gpsLabel.dataset.gps || null;
  const photoFile = document.getElementById('regPhoto').files[0];
  const photoDataUrl = await fileToDataURL(photoFile);

  if (!fullname || !studentId || !year || !dept) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');

  registrationsData[currentActivityId] = registrationsData[currentActivityId] || [];
  const regs = registrationsData[currentActivityId];
  const cap  = activitiesData[currentActivityId]?.capacity || 0;
  if (regs.length >= cap) return alert('‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß');

  regs.push({ fullname, studentId, year, dept, gps: gps || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', photoDataUrl: photoDataUrl || null, ts: new Date().toISOString() });
  saveToLocalStorage();
  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  cancelRegistration();
  loadActivitiesPage();
}
function cancelRegistration() {
  currentActivityId = null;
  document.getElementById('registrationBox').classList.add('hidden');
}

/* ========= 14) INIT ========= */
function initializeData() {
  const loaded = loadFromLocalStorage();
  if (!loaded) {
    studentsData = {
      'accounting-1': [
        { id: '653070310202', name: '‡∏ô.‡∏™.‡∏à‡∏∏‡∏ë‡∏≤‡∏°‡∏≤‡∏® ‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≥', photo: 'üë©‚Äçüéì' },
        { id: '653070310012', name: '‡∏ô.‡∏™.‡∏®‡∏∏‡∏†‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå ‡∏™‡∏µ‡∏´‡∏≤', photo: 'üë©‚Äçüéì' }
      ],
      'accounting-2': [
        { id: '653070320101', name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', photo: 'üë®‚Äçüéì' },
        { id: '653070320102', name: '‡∏ô.‡∏™.‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', photo: 'üë©‚Äçüéì' }
      ],
      'management-1': [
        { id: '653070410101', name: '‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏≤‡∏Å‡∏£ ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', photo: 'üë®‚Äçüéì' },
        { id: '653070410102', name: '‡∏ô.‡∏™.‡∏ß‡∏¥‡∏†‡∏≤‡∏î‡∏≤ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', photo: 'üë©‚Äçüéì' }
      ],
      'it-1': [
        { id: '653070510101', name: '‡∏ô‡∏≤‡∏¢‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° ‡πÄ‡∏°‡∏≠‡∏£‡πå', photo: 'üë®‚Äçüíª' },
        { id: '653070510102', name: '‡∏ô.‡∏™.‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå', photo: 'üë©‚Äçüíª' }
      ]
    };
    attendanceData = {};
    behaviorNotes  = {};
    activitiesData = {};
    registrationsData = {};
    saveToLocalStorage();
  }
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('attendanceDate').value = today;
  document.getElementById('reportDate').value     = today;
  document.getElementById('behaviorDate').value   = today;
}

document.addEventListener('DOMContentLoaded', function () {
  initializeData();
  getLocation();
  loadGoogleSheetsConfig();
});
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MITCheck - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏ß‡∏¢ GPS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Sarabun', sans-serif; }
    .status-present { background-color: #16a34a !important; color: white !important; }
    .status-absent  { background-color: #dc2626 !important; color: white !important; }
    .status-gps     { background-color: #6213a9 !important; color: white !important; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    .mit-purple { background-color: #6213a9; }
    .mit-gold   { background-color: #fac903; }
    .mit-green  { background-color: #16a34a; }
    .mit-red    { background-color: #dc2626; }
    .text-mit-purple { color: #6213a9; }
    .text-mit-gold   { color: #fac903; }
    .border-mit-purple { border-color: #6213a9; }
    .auto-result {
      background: linear-gradient(135deg, #6213a9, #8b5cf6);
      color: white; padding: 20px; border-radius: 12px; margin: 20px 0;
      box-shadow: 0 4px 15px rgba(98, 19, 169, 0.3);
    }
    .data-persistence {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white; padding: 15px; border-radius: 8px; margin: 10px 0;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 border-t-4 border-mit-purple">
      <div class="text-center">
        <h1 class="text-4xl font-bold text-mit-purple mb-2">üéì MITCheck</h1>
        <p class="text-lg text-gray-700 font-medium">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏ß‡∏¢ GPS</p>
        <p class="text-sm text-gray-600">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏° - ‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</p>
      </div>

      <!-- Data Persistence Status -->
      <div class="data-persistence text-center mt-4">
        <p class="text-sm">üíæ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö</p>
      </div>

      <!-- Navigation -->
      <div class="flex flex-wrap justify-center gap-2 mt-4">
        <button onclick="showPage('manage')" class="nav-btn mit-green text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all font-medium">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
        <button onclick="showPage('departments')" class="nav-btn mit-purple text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all font-medium">üè´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</button>
        <button onclick="showPage('daily')" class="nav-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
        <button onclick="showPage('summary')" class="nav-btn mit-purple text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all font-medium">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°</button>
        <button onclick="showPage('activity')" class="nav-btn bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition-colors font-medium">üéüÔ∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏¢‡∏®.</button>
        <button onclick="showPage('settings')" class="nav-btn bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors font-medium">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets</button>
      </div>
    </div>

    <!-- GPS Status -->
    <div id="gpsStatus" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4 rounded hidden">
      <p class="text-yellow-700">üåç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...</p>
    </div>

    <!-- ================= Departments Page (Dropdown version) ================= -->
    <div id="departmentsPage" class="page">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Cards for departments -->
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üìä ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('accounting', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option>
            <option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option>
            <option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üíº ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('management', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option>
            <option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option>
            <option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üì± ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('digital', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option>
            <option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option>
            <option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üíª ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('it', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option>
            <option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option>
            <option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">‚öΩ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('sports', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option>
            <option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option>
            <option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">üéØ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border border-gray-300 rounded-lg px-3 py-2"
                  onchange="if(this.value){showCheckIn('marketing', this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option>
            <option value="1">‡∏õ‡∏µ 1</option>
            <option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option>
            <option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

      </div>
    </div>
    <!-- ================= /Departments Page ================= -->

    <!-- Activity Page -->
    <div id="activityPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üéüÔ∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏¢‡∏™. ‚Äî ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h2>

        <!-- Admin Add Activity -->
        <div class="bg-gray-50 rounded-lg p-6 mb-8">
          <h3 class="text-lg font-semibold mb-4">üë©‚Äçüíº ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input id="actName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" class="border border-gray-300 rounded-lg px-3 py-2">
            <input id="actCapacity" type="number" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö (‡∏Ñ‡∏ô)" class="border border-gray-300 rounded-lg px-3 py-2">
            <button onclick="addActivity()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
          </div>
          <p class="text-sm text-gray-500 mt-2">* ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ</p>
        </div>

        <!-- Activity List -->
        <div>
          <h3 class="text-lg font-semibold mb-3">üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</h3>
          <div id="activityList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Registration Box -->
        <div id="registrationBox" class="mt-8 hidden">
          <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: <span id="regActTitle" class="font-bold"></span></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input id="regFullname" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="border border-gray-300 rounded-lg px-3 py-2">
              <input id="regStudentId" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" class="border border-gray-300 rounded-lg px-3 py-2">
              <select id="regYear" class="border border-gray-300 rounded-lg px-3 py-2">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option>
                <option value="1">‡∏õ‡∏µ 1</option>
                <option value="2">‡∏õ‡∏µ 2</option>
                <option value="3">‡∏õ‡∏µ 3</option>
                <option value="4">‡∏õ‡∏µ 4</option>
              </select>
              <select id="regDept" class="border border-gray-300 rounded-lg px-3 py-2">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                <option value="accounting">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                <option value="management">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
                <option value="digital">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
                <option value="it">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
                <option value="sports">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</option>
                <option value="marketing">‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
              </select>
              <input id="regPhoto" type="file" accept="image/*" class="border border-gray-300 rounded-lg px-3 py-2 md:col-span-2">
            </div>

            <div class="mt-4 flex flex-wrap gap-3">
              <button onclick="captureGPSForRegistration()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">üìç ‡∏î‡∏∂‡∏á GPS</button>
              <span id="regGPS" class="text-sm text-gray-700 self-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</span>
            </div>

            <div class="mt-6">
              <button onclick="saveRegistration()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <button onclick="cancelRegistration()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 ml-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Check-in Page -->
    <div id="checkinPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-800" id="checkinTitle">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h2>
            <p class="text-gray-600" id="checkinSubtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
          </div>
          <button onclick="showPage('departments')" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>

        <!-- Date Picker -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="attendanceDate" class="border border-gray-300 rounded-lg px-3 py-2" onchange="loadAttendanceData()">
        </div>

        <!-- GPS Info -->
        <div id="gpsInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <p class="text-blue-800">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentLocation">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
        </div>

        <!-- Student List -->
        <div id="studentList" class="space-y-3 mb-6"></div>

        <!-- Save Button -->
        <div class="text-center space-y-3">
          <button onclick="saveAttendance()" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors text-lg font-semibold">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <br>
          <button onclick="sendToGoogleSheets()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">üìä ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets</button>
        </div>

        <!-- Auto Result Display -->
        <div id="saveResult" class="mt-4 hidden">
          <div class="auto-result text-center">
            <div class="text-2xl mb-3">üéâ</div>
            <h3 class="text-xl font-bold mb-4">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                <p class="font-bold text-lg">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>
              </div>
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                <p class="font-bold text-lg" id="attendancePercentage">üìä 0%</p>
              </div>
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p>
                <p class="font-bold text-lg" id="checkTime">‚è∞ --:-- ‡∏ô.</p>
              </div>
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <p class="text-sm opacity-90">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</p>
                <p class="font-bold text-lg" id="gpsCoordinates">üìç ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</p>
              </div>
            </div>
            <div class="mt-4 bg-white bg-opacity-20 rounded-lg p-3">
              <p class="text-sm opacity-90">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
              <p class="font-bold" id="dailySummary">‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° 0 ‡∏Ñ‡∏ô ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 0 ‡∏Ñ‡∏ô</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Manage Students Page -->
    <div id="managePage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>

        <!-- Add Student Form -->
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="newStudentId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" class="border border-gray-300 rounded-lg px-3 py-2">
            <input type="text" id="newStudentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="border border-gray-300 rounded-lg px-3 py-2">
            <select id="newStudentDept" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
              <option value="accounting">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
              <option value="management">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
              <option value="digital">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
              <option value="it">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
              <option value="sports">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</option>
              <option value="marketing">‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
            </select>
            <select id="newStudentYear" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option>
              <option value="1">‡∏õ‡∏µ 1</option>
              <option value="2">‡∏õ‡∏µ 2</option>
              <option value="3">‡∏õ‡∏µ 3</option>
              <option value="4">‡∏õ‡∏µ 4</option>
            </select>
          </div>
          <button onclick="addStudent()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
        </div>

        <!-- Students List -->
        <div id="manageStudentList"></div>
      </div>
    </div>

    <!-- Daily Report Page -->
    <div id="dailyPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="reportDate" class="border border-gray-300 rounded-lg px-3 py-2" onchange="loadDailyReport()">
        </div>

        <div id="dailyReportContent"></div>
      </div>
    </div>

    <!-- Summary Report Page -->
    <div id="summaryPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°</h2>
        <div id="summaryReportContent"></div>
      </div>
    </div>

    <!-- Behavior Notes Page -->
    <div id="behaviorPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h2>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="behaviorDate" class="border border-gray-300 rounded-lg px-3 py-2" onchange="loadBehaviorNotes()">
        </div>

        <div id="behaviorNotesContent"></div>
      </div>
    </div>

    <!-- Google Sheets Settings Page -->
    <div id="settingsPage" class="page hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets</h2>

        <!-- Instructions -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets (‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</h3>

          <div class="space-y-4 text-sm text-blue-700">
            <div class="bg-white rounded p-3">
              <h4 class="font-semibold mb-2">üîß ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Apps Script</h4>
              <ol class="list-decimal list-inside space-y-1 ml-2">
                <li>‡πÄ‡∏õ‡∏¥‡∏î <a href="https://script.google.com" target="_blank" class="underline text-blue-600">script.google.com</a></li>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà" (New Project)</li>
                <li>‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</li>
                <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Ctrl+S) ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ "MITCheck-Sync"</li>
              </ol>
            </div>

            <div class="bg-white rounded p-3">
              <h4 class="font-semibold mb-2">üìä ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Sheets</h4>
              <ol class="list-decimal list-inside space-y-1 ml-2">
                <li>‡πÄ‡∏õ‡∏¥‡∏î <a href="https://sheets.google.com" target="_blank" class="underline text-blue-600">sheets.google.com</a></li>
                <li>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡∏°‡πà ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ "MITCheck-Data"</li>
                <li>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID ‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ó (‡∏à‡∏≤‡∏Å URL ‡∏´‡∏•‡∏±‡∏á /d/ ‡πÅ‡∏•‡∏∞‡∏Å‡πà‡∏≠‡∏ô /edit)</li>
                <li>‡πÉ‡∏™‡πà ID ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</li>
              </ol>
            </div>

            <div class="bg-white rounded p-3">
              <h4 class="font-semibold mb-2">üöÄ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: Deploy Web App</h4>
              <ol class="list-decimal list-inside space-y-1 ml-2">
                <li>‡πÉ‡∏ô Apps Script ‡∏Ñ‡∏•‡∏¥‡∏Å "Deploy" > "New deployment"</li>
                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Type: "Web app"</li>
                <li>Execute as: "Me"</li>
                <li>Who has access: "Anyone"</li>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Deploy" ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL</li>
                <li>‡πÉ‡∏™‡πà URL ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Google Apps Script Code -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <h3 class="text-lg font-semibold mb-3">üìù ‡πÇ‡∏Ñ‡πâ‡∏î Google Apps Script (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏ß‡∏≤‡∏á)</h3>
<textarea readonly class="w-full h-64 bg-white border border-gray-300 rounded p-3 text-sm font-mono" onclick="this.select()">function doPost(e) {
  try {
    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MITCheck
    const data = JSON.parse(e.postData.contents);
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Google Sheets (‡πÉ‡∏™‡πà ID ‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ó‡∏Ñ‡∏∏‡∏ì)
    const SHEET_ID = '‡πÉ‡∏™‡πà_SHEET_ID_‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Header ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (sheet.getLastRow() === 0) {
      sheet.getRange(1, 1, 1, 8).setValues([[
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', 
        '‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS'
      ]]);
      
      // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Header
      const headerRange = sheet.getRange(1, 1, 1, 8);
      headerRange.setBackground('#6213a9');
      headerRange.setFontColor('white');
      headerRange.setFontWeight('bold');
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    data.records.forEach(record => {
      sheet.appendRow([
        record.date,
        record.time,
        record.studentId,
        record.studentName,
        record.department,
        record.year,
        record.status,
        record.gps
      ]);
    });
    
    // ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${data.records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`,
        timestamp: new Date().toLocaleString('th-TH')
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</textarea>
        </div>

        <!-- Configuration Form -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">üîó Web App URL:</label>
            <input type="url" id="webAppUrl" placeholder="https://script.google.com/macros/s/YOUR_ID/exec"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2"
                   value="https://script.google.com/macros/s/AKfycbwMBhYZCXuWCovPjkIxjiV8jeN-jgLHZlt7DQ5QGvJg8O4j5yf2wTnRrd89aPSdC9A/exec">
            <p class="text-xs text-gray-500 mt-1">URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Web App</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">üìä Google Sheets ID:</label>
            <input type="text" id="sheetsId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"
                   class="w-full border border-gray-300 rounded-lg px-3 py-2"
                   value="">
            <p class="text-xs text-gray-500 mt-1">ID ‡∏Ç‡∏≠‡∏á Google Sheets (‡∏à‡∏≤‡∏Å URL)</p>
          </div>
        </div>

        <div class="mt-6 flex space-x-4">
          <button onclick="saveGoogleSheetsConfig()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
          <button onclick="testGoogleSheetsConnection()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="mt-4 hidden"></div>

        <!-- Sample Data Format -->
        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-yellow-800 mb-3">üìã ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-2 py-1 border text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th class="px-2 py-1 border text-left">‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th class="px-2 py-1 border text-left">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                  <th class="px-2 py-1 border text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th class="px-2 py-1 border text-left">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                  <th class="px-2 py-1 border text-left">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</th>
                  <th class="px-2 py-1 border text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th class="px-2 py-1 border text-left">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="px-2 py-1 border">2024-01-15</td>
                  <td class="px-2 py-1 border">08:30:00</td>
                  <td class="px-2 py-1 border">653070310202</td>
                  <td class="px-2 py-1 border">‡∏ô.‡∏™.‡∏à‡∏∏‡∏ë‡∏≤‡∏°‡∏≤‡∏® ‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≥</td>
                  <td class="px-2 py-1 border">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</td>
                  <td class="px-2 py-1 border">1</td>
                  <td class="px-2 py-1 border">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</td>
                  <td class="px-2 py-1 border">17.4138, 104.7734</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /container -->

  <script>
// ========= 0) CONFIG + HELPERS =========
const DEFAULT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz-SvRm-a9w-SL4MBA1SyayxndAupAeuev8nT2vLz8NZ-R2W-sSVisVcZ3mS7zZr06x/exec"; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Settings ‡∏Å‡πá‡πÑ‡∏î‡πâ
const DEFAULT_SHEETS_ID  = "1ST0Pe4mojfQiWQRR589BTXj0mWqfRorMAsJFKWs89Pc";

let googleSheetsConfig = { webAppUrl: DEFAULT_WEBAPP_URL, sheetsId: DEFAULT_SHEETS_ID };

async function safeGet(url, params = {}) {
  const u = new URL(url);
  Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
  const res  = await fetch(u.toString(), { method:'GET' });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error(`HTTP ${res.status} ${res.statusText}: ${text?.slice(0,200)||'(empty)'}`); }
}
async function safePost(url, payload = {}) {
  const res  = await fetch(url, {
    method: 'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error(`HTTP ${res.status} ${res.statusText}: ${text?.slice(0,200)||'(empty)'}`); }
}

async function gsPost(payload = {}) {
  if (!googleSheetsConfig?.webAppUrl) {
    throw new Error('Web App URL is not set');
  }
  // ‡πÉ‡∏ä‡πâ FormData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS/preflight
  const fd = new FormData();
  fd.append('payload', JSON.stringify(payload));

  const res  = await fetch(googleSheetsConfig.webAppUrl, { method: 'POST', body: fd, credentials: 'omit' });
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { return { success:false, error: text?.slice(0,200) || 'Bad response' }; }
}

// ========= 1) GLOBAL STATE =========
let currentDepartment = '';
let currentYear = '';
let currentLocation = null;

let studentsData = {};
let attendanceData = {};
let behaviorNotes = {};

let activitiesData = {};      // { actId: { id, name, capacity, createdAt } }
let registrationsData = {};   // { actId: [ { fullname, studentId, year, dept, gps, photoDataUrl, ts } ] }
let currentActivityId = null;

// ========= 2) PERSISTENCE (LOCALSTORAGE) =========
function saveToLocalStorage() {
  const data = {
    students: studentsData,
    attendance: attendanceData,
    behavior: behaviorNotes,
    activities: activitiesData,
    registrations: registrationsData,
    lastUpdated: new Date().toISOString()
  };
  localStorage.setItem('mitcheck_data', JSON.stringify(data));
}
function loadFromLocalStorage() {
  const saved = localStorage.getItem('mitcheck_data');
  if (!saved) return false;
  try {
    const data = JSON.parse(saved);
    studentsData      = data.students || {};
    attendanceData    = data.attendance || {};
    behaviorNotes     = data.behavior || {};
    activitiesData    = data.activities || {};
    registrationsData = data.registrations || {};
    showDataLoadedMessage(data.lastUpdated);
    return true;
  } catch { return false; }
}
function showDataLoadedMessage(lastUpdated) {
  if (!lastUpdated) return;
  const date = new Date(lastUpdated);
  const formattedDate = date.toLocaleDateString('th-TH', {
    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
  });
  const messageDiv = document.createElement('div');
  messageDiv.className = 'data-persistence text-center mb-4';
  messageDiv.innerHTML = `<p class="text-sm">üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${formattedDate}</p>`;
  const container = document.querySelector('.container');
  container.insertBefore(messageDiv, container.children[1]);
  setTimeout(() => { messageDiv.remove(); }, 5000);
}
function clearAllData() {
  if (!confirm('‚ö†Ô∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠/‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)')) return;
  localStorage.removeItem('mitcheck_data');
  studentsData = {}; attendanceData = {}; behaviorNotes = {};
  activitiesData = {}; registrationsData = {};
  alert('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä');
  location.reload();
}

// ========= 3) GPS =========
function getLocation() {
  document.getElementById('gpsStatus')?.classList.remove('hidden');
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        currentLocation = { latitude: position.coords.latitude, longitude: position.coords.longitude };
        const el = document.getElementById('currentLocation');
        if (el) el.textContent = `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
        document.getElementById('gpsStatus')?.classList.add('hidden');
      },
      () => {
        const el = document.getElementById('currentLocation');
        if (el) el.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';
        document.getElementById('gpsStatus')?.classList.add('hidden');
        currentLocation = { latitude: 17.4138, longitude: 104.7734 }; // fallback
      }
    );
  } else {
    const el = document.getElementById('currentLocation');
    if (el) el.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS';
    document.getElementById('gpsStatus')?.classList.add('hidden');
    currentLocation = { latitude: 17.4138, longitude: 104.7734 };
  }
}

// ========= 4) NAVIGATION =========
function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.getElementById(pageId + 'Page')?.classList.remove('hidden');
  if (pageId === 'manage')      loadManageStudents();
  else if (pageId === 'daily')  loadDailyReport();
  else if (pageId === 'summary')loadSummaryReport();
  else if (pageId === 'behavior')loadBehaviorNotes();
  else if (pageId === 'settings')loadGoogleSheetsConfig();
  else if (pageId === 'activity')loadActivitiesPage();
}
function showCheckIn(department, year) {
  currentDepartment = department;
  currentYear = year;
  const deptNames = {
    accounting: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', management: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', digital: '‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
    it: '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®', sports: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤', marketing: '‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î'
  };
  document.getElementById('checkinTitle').textContent =
    `‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ${deptNames[department]} ‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${year}`;
  document.getElementById('checkinSubtitle').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤`;
  showPage('checkin');
  getLocation();
  loadStudentList();
}

// ========= 5) STUDENTS / ATTENDANCE UI =========
function loadStudentList() {
  const key = `${currentDepartment}-${currentYear}`;
  const students = studentsData[key] || [];
  const studentListDiv = document.getElementById('studentList');
  studentListDiv.innerHTML = '';

  students.forEach(student => {
    const row = document.createElement('div');
    row.className = 'student-row bg-gray-50 rounded-lg p-4 border border-gray-200';
    row.id = `student-${student.id}`;
    row.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="text-4xl">${student.photo || 'üë§'}</div>
          <div>
            <h3 class="font-semibold text-gray-800">${student.name}</h3>
            <p class="text-sm text-gray-600">${student.id}</p>
          </div>
        </div>
        <div class="flex space-x-2">
          <button onclick="setStatus('${student.id}', 'present')" class="status-btn bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors">‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
          <button onclick="setStatus('${student.id}', 'absent')"  class="status-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors">‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
          <button onclick="setStatus('${student.id}', 'gps')"     class="status-btn bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 transition-colors">üìç ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        </div>
      </div>`;
    studentListDiv.appendChild(row);
  });
}
function setStatus(studentId, status) {
  const studentRow = document.getElementById(`student-${studentId}`);
  const date = document.getElementById('attendanceDate').value;
  studentRow.classList.remove('status-present', 'status-absent', 'status-gps');
  studentRow.classList.add(`status-${status}`);
  if (!attendanceData[date]) attendanceData[date] = {};
  attendanceData[date][studentId] = {
    status,
    timestamp: new Date().toLocaleString('th-TH'),
    location: currentLocation,
    department: currentDepartment,
    year: currentYear
  };
}
function saveAttendance() {
  const date = document.getElementById('attendanceDate').value;
  const dayData = attendanceData[date] || {};
  const key = `${currentDepartment}-${currentYear}`;
  const students = studentsData[key] || [];

  let present = 0, absent = 0, gps = 0, total = students.length;
  students.forEach(s => {
    if (dayData[s.id]) {
      const st = dayData[s.id].status;
      if (st === 'present') present++;
      else if (st === 'absent') absent++;
      else if (st === 'gps') gps++;
    }
  });

  const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
  const currentTime = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });

  document.getElementById('attendancePercentage').textContent = `üìä ${percentage}%`;
  document.getElementById('checkTime').textContent = `‚è∞ ${currentTime} ‡∏ô.`;
  if (currentLocation) {
    const lat = currentLocation.latitude.toFixed(4);
    const lng = currentLocation.longitude.toFixed(4);
    document.getElementById('gpsCoordinates').textContent = `üìç ${lat}, ${lng} (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢)`;
  }
  document.getElementById('dailySummary').textContent =
    `‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ${present} ‡∏Ñ‡∏ô ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏Ñ‡∏ô (‡∏Ç‡∏≤‡∏î ${absent} ‡∏Ñ‡∏ô, ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î ${gps} ‡∏Ñ‡∏ô)`;

  saveToLocalStorage();
  const box = document.getElementById('saveResult');
  box.classList.remove('hidden');
  setTimeout(() => box.classList.add('hidden'), 8000);
}

// ========= 6) MANAGE STUDENTS =========
function addStudent() {
  const id   = document.getElementById('newStudentId').value.trim();
  const name = document.getElementById('newStudentName').value.trim();
  const dept = document.getElementById('newStudentDept').value;
  const year = document.getElementById('newStudentYear').value;
  if (!id || !name || !dept || !year) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');

  const key = `${dept}-${year}`;
  if (studentsData[key]?.find(s => s.id === id)) return alert('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');

  studentsData[key] = studentsData[key] || [];
  studentsData[key].push({ id, name, photo: 'üë§' });
  saveToLocalStorage();

  document.getElementById('newStudentId').value = '';
  document.getElementById('newStudentName').value = '';
  document.getElementById('newStudentDept').value = '';
  document.getElementById('newStudentYear').value = '';
  loadManageStudents();
  alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}
function loadManageStudents() {
  const manageList = document.getElementById('manageStudentList');
  manageList.innerHTML = '';
  Object.keys(studentsData).forEach(key => {
    const [dept, year] = key.split('-');
    const deptNames = {
      accounting: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', management: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', digital: '‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
      it: '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®', sports: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤', marketing: '‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î'
    };
    const section = document.createElement('div');
    section.className = 'mb-6 bg-gray-50 rounded-lg p-4';
    section.innerHTML = `
      <h3 class="text-lg font-semibold mb-3">${deptNames[dept]} ‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${year}</h3>
      <div class="space-y-2" id="students-${key}"></div>`;
    manageList.appendChild(section);

    const holder = document.getElementById(`students-${key}`);
    studentsData[key].forEach((st, idx) => {
      const line = document.createElement('div');
      line.className = 'flex items-center justify-between bg-white p-3 rounded border';
      line.innerHTML = `
        <div class="flex items-center space-x-3">
          <span class="text-2xl">${st.photo || 'üë§'}</span>
          <div>
            <p class="font-medium">${st.name}</p>
            <p class="text-sm text-gray-600">${st.id}</p>
          </div>
        </div>
        <button onclick="removeStudent('${key}', ${idx})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors">üóëÔ∏è ‡∏•‡∏ö</button>`;
      holder.appendChild(line);
    });
  });
}
function removeStudent(key, index) {
  const st = studentsData[key][index];
  if (!confirm(`‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n${st.name}\n${st.id}`)) return;
  studentsData[key].splice(index, 1);
  Object.keys(attendanceData).forEach(date => { if (attendanceData[date][st.id]) delete attendanceData[date][st.id]; });
  Object.keys(behaviorNotes).forEach(k => { if (k.includes(st.id)) delete behaviorNotes[k]; });
  saveToLocalStorage();
  loadManageStudents();
  alert('‚úÖ ‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// ========= 7) REPORTS =========
function loadDailyReport() {
  const date = document.getElementById('reportDate').value;
  const el = document.getElementById('dailyReportContent');
  if (!date) return el.innerHTML = '<p class="text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>';

  const dayData = attendanceData[date] || {};
  if (Object.keys(dayData).length === 0) return el.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';

  let html = `
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-300">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 border text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="px-4 py-2 border text-left">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
          <th class="px-4 py-2 border text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="px-4 py-2 border text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="px-4 py-2 border text-left">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ</th>
          <th class="px-4 py-2 border text-left">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</th>
        </tr>
      </thead>
      <tbody>`;
  Object.keys(dayData).forEach(id => {
    const r = dayData[id];
    const key = `${r.department}-${r.year}`;
    const st = studentsData[key]?.find(s => s.id === id);
    const statusText = { present:'‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', absent:'‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', gps:'üìç ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î' }[r.status] || r.status;
    const gpsText = r.location ? `${r.location.latitude.toFixed(6)}, ${r.location.longitude.toFixed(6)}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    html += `
      <tr>
        <td class="px-4 py-2 border">${date}</td>
        <td class="px-4 py-2 border">${id}</td>
        <td class="px-4 py-2 border">${st ? st.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</td>
        <td class="px-4 py-2 border">${statusText}</td>
        <td class="px-4 py-2 border">${r.timestamp}</td>
        <td class="px-4 py-2 border">${gpsText}</td>
      </tr>`;
  });
  html += '</tbody></table></div>';
  el.innerHTML = html;
}
function loadSummaryReport() {
  const el = document.getElementById('summaryReportContent');
  let summary = {};
  Object.keys(studentsData).forEach(k => {
    studentsData[k].forEach(s => summary[s.id] = { name:s.name, present:0, absent:0, total:0 });
  });
  Object.keys(attendanceData).forEach(date => {
    Object.keys(attendanceData[date]).forEach(id => {
      if (!summary[id]) return;
      const st = attendanceData[date][id].status;
      summary[id].total++;
      if (st === 'present') summary[id].present++;
      else if (st === 'absent') summary[id].absent++;
    });
  });

  let html = `
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-300">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 border text-left">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
          <th class="px-4 py-2 border text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="px-4 py-2 border text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
          <th class="px-4 py-2 border text-center">‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
          <th class="px-4 py-2 border text-center">% ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
        </tr>
      </thead>
      <tbody>`;
  Object.keys(summary).forEach(id => {
    const d = summary[id];
    const pct = d.total > 0 ? Math.round((d.present / d.total) * 100) : 0;
    html += `
    <tr>
      <td class="px-4 py-2 border">${id}</td>
      <td class="px-4 py-2 border">${d.name}</td>
      <td class="px-4 py-2 border text-center">${d.present}</td>
      <td class="px-4 py-2 border text-center">${d.absent}</td>
      <td class="px-4 py-2 border text-center">${pct}%</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  el.innerHTML = html;
}

// ========= 8) BEHAVIOR NOTES =========
function loadBehaviorNotes() {
  const date = document.getElementById('behaviorDate').value;
  const el = document.getElementById('behaviorNotesContent');
  if (!date) return el.innerHTML = '<p class="text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>';

  const dayData = attendanceData[date] || {};
  if (Object.keys(dayData).length === 0)
    return el.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';

  let html = '<div class="space-y-4">';
  Object.keys(dayData).forEach(id => {
    const r = dayData[id];
    const key = `${r.department}-${r.year}`;
    const st = studentsData[key]?.find(s => s.id === id);
    if (!st) return;
    const noteKey = `${date}-${id}`;
    const currentNote = behaviorNotes[noteKey] || '';
    html += `
      <div class="bg-gray-50 rounded-lg p-4">
        <div class="flex items-center space-x-3 mb-3">
          <span class="text-2xl">${st.photo || 'üë§'}</span>
          <div>
            <h3 class="font-semibold">${st.name}</h3>
            <p class="text-sm text-gray-600">${id}</p>
          </div>
        </div>
        <textarea id="note-${id}" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‚Ä¶"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 h-20 resize-none"
          onchange="saveBehaviorNote('${date}', '${id}')">${currentNote}</textarea>
      </div>`;
  });
  html += '</div>';
  el.innerHTML = html;
}
function saveBehaviorNote(date, studentId) {
  const noteText = document.getElementById(`note-${studentId}`).value;
  behaviorNotes[`${date}-${studentId}`] = noteText;
  saveToLocalStorage();
  const el = document.getElementById(`note-${studentId}`);
  const orig = el.style.borderColor;
  el.style.borderColor = '#16a34a'; el.style.borderWidth = '2px';
  setTimeout(()=>{ el.style.borderColor = orig; el.style.borderWidth = '1px'; },1000);
}
function loadAttendanceData() {
  const date = document.getElementById('attendanceDate').value;
  const key = `${currentDepartment}-${currentYear}`;
  const students = studentsData[key] || [];
  loadStudentList();
  if (!attendanceData[date]) return;

  students.forEach(s => {
    if (attendanceData[date][s.id]) {
      const st = attendanceData[date][s.id].status;
      const row = document.getElementById(`student-${s.id}`);
      if (row) {
        row.classList.remove('status-present', 'status-absent', 'status-gps');
        row.classList.add(`status-${st}`);
      }
    }
  });

  const msg = document.createElement('div');
  msg.className = 'bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg mb-4';
  msg.innerHTML = `üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
  const holder = document.getElementById('studentList');
  holder.parentNode.insertBefore(msg, holder);
  setTimeout(()=>msg.remove(), 3000);
}

// ========= 9) GOOGLE SHEETS CONFIG + STATUS =========
function loadGoogleSheetsConfig() {
  const saved = localStorage.getItem('mitcheck_google_config');
  if (saved) {
    try {
      const cfg = JSON.parse(saved);
      googleSheetsConfig = {
        webAppUrl: cfg.webAppUrl || googleSheetsConfig.webAppUrl,
        sheetsId:  cfg.sheetsId  || googleSheetsConfig.sheetsId
      };
    } catch {}
  }
  const urlEl = document.getElementById('webAppUrl');
  const idEl  = document.getElementById('sheetsId');
  if (urlEl) urlEl.value = googleSheetsConfig.webAppUrl || '';
  if (idEl)  idEl.value  = googleSheetsConfig.sheetsId || '';
}
function saveGoogleSheetsConfig() {
  const webAppUrl = document.getElementById('webAppUrl').value.trim();
  const sheetsId  = document.getElementById('sheetsId').value.trim();
  if (!webAppUrl || !sheetsId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Web App URL ‡πÅ‡∏•‡∏∞ Sheets ID ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
  googleSheetsConfig = { webAppUrl, sheetsId };
  localStorage.setItem('mitcheck_google_config', JSON.stringify(googleSheetsConfig));
  showConnectionStatus('success', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}
function showConnectionStatus(type, message) {
  const status = document.getElementById('connectionStatus');
  if (!status) return;
  status.classList.remove('hidden');
  const color = type==='success' ? ['bg-green-100','border-green-400','text-green-700']
              : type==='error'   ? ['bg-red-100','border-red-400','text-red-700']
              : ['bg-blue-100','border-blue-400','text-blue-700'];
  status.className = `mt-4 p-4 rounded-lg border ${color.join(' ')}`;
  status.innerHTML = message;
  if (type !== 'loading') setTimeout(()=>status.classList.add('hidden'), 5000);
}
function testGoogleSheetsConnection() {
  if (!googleSheetsConfig.webAppUrl) return alert('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL ‡∏Å‡πà‡∏≠‡∏ô');
  showConnectionStatus('loading', 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');

  const testData = {
    sheetsId: googleSheetsConfig.sheetsId,
    records: [{
      date: new Date().toISOString().split('T')[0],
      time: new Date().toLocaleTimeString('th-TH'),
      studentId: 'TEST001',
      studentName: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö',
      department: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
      year: '1',
      status: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
      gps: '17.4138, 104.7734'
    }]
  };

  gsPost(testData)
    .then(d => showConnectionStatus(d.success?'success':'error',
            d.success ? `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${d.message||''}` : `‚ùå ${d.error||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`))
    .catch(err => showConnectionStatus('error', `‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ${err.message}`));
}

// ========= 10) SEND TO SHEETS =========
function sendToGoogleSheets() {
  if (!googleSheetsConfig.webAppUrl) return alert('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets ‡∏Å‡πà‡∏≠‡∏ô');

  const date = document.getElementById('attendanceDate').value;
  const dayData = attendanceData[date] || {};
  if (Object.keys(dayData).length === 0) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');

  const deptNames   = { accounting:'‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', management:'‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', digital:'‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•', it:'‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®', sports:'‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤', marketing:'‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î' };
  const statusNames = { present:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', absent:'‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', gps:'‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î' };

  const records = [];
  Object.keys(dayData).forEach(id => {
    const r = dayData[id];
    const key = `${r.department}-${r.year}`;
    const st  = studentsData[key]?.find(s => s.id === id);
    if (!st) return;
    const gpsText = r.location ? `${r.location.latitude.toFixed(6)}, ${r.location.longitude.toFixed(6)}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    records.push({
      date,
      time: r.timestamp?.split(' ')[1] || new Date().toLocaleTimeString('th-TH'),
      studentId: id,
      studentName: st.name,
      department: deptNames[r.department] || r.department,
      year: r.year,
      status: statusNames[r.status] || r.status,
      gps: gpsText
    });
  });
  if (!records.length) return alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á');

  const toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  toast.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets...';
  document.body.appendChild(toast);

  gsPost({ sheetsId: googleSheetsConfig.sheetsId, records })
    .then(d => {
      toast.remove();
      if (!d.success) throw new Error(d.error || 'unknown');
      const ok = document.createElement('div');
      ok.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      ok.innerHTML = `<div class="text-center"><div class="text-2xl mb-2">üéâ</div><div class="font-bold">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div><div class="text-sm mt-1">${d.message}</div><div class="text-xs mt-1">‡πÄ‡∏ß‡∏•‡∏≤: ${d.timestamp}</div></div>`;
      document.body.appendChild(ok);
      setTimeout(()=>ok.remove(), 5000);
      if (googleSheetsConfig.sheetsId) {
        window.open(`https://docs.google.com/spreadsheets/d/${googleSheetsConfig.sheetsId}/edit`, '_blank', 'noopener,noreferrer');
      }
    })
    .catch(err => {
      toast.remove();
      const bad = document.createElement('div');
      bad.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      bad.innerHTML = `<div class="text-center"><div class="text-2xl mb-2">‚ùå</div><div class="font-bold">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div><div class="text-sm mt-1">${err.message}</div><div class="text-xs mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div></div>`;
      document.body.appendChild(bad);
      setTimeout(()=>bad.remove(), 8000);
    });
}

// ========= 11) REGISTRATIONS (EXPORT) =========
function exportRegistrations(actId) {
  if (!googleSheetsConfig.webAppUrl) return alert('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets ‡∏Å‡πà‡∏≠‡∏ô');
  const act  = activitiesData[actId];
  const regs = registrationsData[actId] || [];
  if (!act) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ');
  if (!regs.length) return alert('‚ùå ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');

  const records = regs.map(r => {
    const d = new Date(r.ts || Date.now());
    return {
      date: d.toISOString().split('T')[0],
      time: d.toLocaleTimeString('th-TH'),
      studentId: r.studentId,
      studentName: r.fullname,
      department: r.dept,
      year: r.year,
      status: `‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${act.name}`,
      gps: r.gps || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
      activityId: act.id || actId,
      activityName: act.name || ''
    };
  });

  const toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  toast.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ Google Sheets...';
  document.body.appendChild(toast);

  gsPost({ type:'registrations', sheetsId: googleSheetsConfig.sheetsId, records })
    .then(d => {
      toast.remove();
      if (!d.success) throw new Error(d.error || 'unknown');
      const ok = document.createElement('div');
      ok.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      ok.innerHTML = `<div class="text-center"><div class="text-2xl mb-1">üéâ</div><div class="font-bold">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div><div class="text-sm mt-1">${d.message}</div><div class="text-xs mt-1">‡πÄ‡∏ß‡∏•‡∏≤: ${d.timestamp}</div></div>`;
      document.body.appendChild(ok);
      setTimeout(()=>ok.remove(), 6000);
      if (googleSheetsConfig.sheetsId) {
        window.open(`https://docs.google.com/spreadsheets/d/${googleSheetsConfig.sheetsId}/edit#gid=0`, '_blank', 'noopener,noreferrer');
      }
    })
    .catch(err => {
      toast.remove();
      const bad = document.createElement('div');
      bad.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      bad.innerHTML = `<div class="text-center"><div class="text-2xl mb-1">‚ùå</div><div class="font-bold">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div><div class="text-sm mt-1">${err.message}</div><div class="text-xs mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div></div>`;
      document.body.appendChild(bad);
      setTimeout(()=>bad.remove(), 8000);
    });
}

// ========= 12) ACTIVITIES (CRUD + SERVER SYNC) =========
async function addActivity() {
  const name = document.getElementById('actName').value.trim();
  const capacity = parseInt(document.getElementById('actCapacity').value, 10);
  if (!name || !capacity || capacity < 1) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  if (!googleSheetsConfig.webAppUrl) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL');

  const toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  toast.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...';
  document.body.appendChild(toast);

  try {
    const res = await gsPost({ type:'addactivity', sheetsId: googleSheetsConfig.sheetsId, name, capacity })
    toast.remove();
    if (!res.success) throw new Error(res.error || 'create failed');

    const id = res.id || ('act_' + Math.random().toString(36).slice(2,10));
    activitiesData[id] = { id, name, capacity, createdAt: new Date().toISOString() };
    saveToLocalStorage();

    alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    document.getElementById('actName').value = '';
    document.getElementById('actCapacity').value = '';
    loadActivitiesPage();
  } catch (err) {
    toast.remove();
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
  }
}
async function loadActivitiesPage() {
  const list = document.getElementById('activityList');
  list.innerHTML = '<div class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‚Ä¶</div>';

try {
  const res = await gsPost({ type:'listactivities', sheetsId: googleSheetsConfig.sheetsId });
  if (res.success && Array.isArray(res.data)) {
    activitiesData = {};
    res.data.forEach(a => { activitiesData[a.id] = { id:a.id, name:a.name, capacity:Number(a.capacity||0), createdAt:a.createdAt || new Date().toISOString() }; });
    saveToLocalStorage();
  }
} catch(e) {
  console.warn('listactivities failed:', e.message);
}

  // render from cache
  list.innerHTML = '';
  const ids = Object.keys(activitiesData);
  if (!ids.length) return list.innerHTML = '<div class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</div>';

  ids.forEach(id => {
    const act  = activitiesData[id];
    const regs = registrationsData[id] || [];
    const remaining = Math.max(0, (act.capacity||0) - regs.length);
    const card = document.createElement('div');
    card.className = 'bg-white rounded-lg border p-4 flex flex-col';
    card.innerHTML = `
      <div class="flex-1">
        <h4 class="font-semibold text-gray-800">${act.name}</h4>
        <p class="text-sm text-gray-600 mt-1">‡∏£‡∏±‡∏ö: ${act.capacity} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${regs.length} ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="${remaining>0?'text-green-700':'text-red-700'} font-semibold">${remaining}</span></p>
        <p class="text-xs text-gray-500 mt-1">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(act.createdAt).toLocaleString('th-TH')}</p>
      </div>
      <div class="mt-3 flex gap-2">
        <button ${remaining===0?'disabled':''}
          onclick="selectActivity('${id}')"
          class="px-4 py-2 rounded-lg text-white ${remaining===0?'bg-gray-400 cursor-not-allowed':'bg-indigo-600 hover:bg-indigo-700'}">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        <button onclick="exportRegistrations('${id}')" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">üì§ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ Google Sheets</button>
        <button onclick="removeActivity('${id}')" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">üóëÔ∏è ‡∏•‡∏ö</button>
      </div>`;
    list.appendChild(card);
  });
}
function removeActivity(id) {
  if (!confirm('‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  delete activitiesData[id];
  delete registrationsData[id];
  saveToLocalStorage();
  loadActivitiesPage();
}
function selectActivity(id) {
  currentActivityId = id;
  document.getElementById('regActTitle').textContent = activitiesData[id]?.name || '';
  document.getElementById('registrationBox').classList.remove('hidden');
  document.getElementById('regFullname').value = '';
  document.getElementById('regStudentId').value = '';
  document.getElementById('regYear').value = '';
  document.getElementById('regDept').value = '';
  document.getElementById('regPhoto').value = '';
  document.getElementById('regGPS').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î';
  delete document.getElementById('regGPS').dataset.gps;
}

// ========= 13) REGISTRATION (FORM) =========
function fileToDataURL(file) {
  return new Promise((resolve) => {
    if (!file) return resolve(null);
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.readAsDataURL(file);
  });
}
function captureGPSForRegistration() {
  const label = document.getElementById('regGPS');
  label.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...';
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        label.textContent = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat}, ${lng}`;
        label.dataset.gps = `${lat}, ${lng}`;
      },
      () => {
        label.textContent = '‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ demo: 17.4138, 104.7734)';
        label.dataset.gps = '17.413800, 104.773400';
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  } else {
    label.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ demo: 17.4138, 104.7734)';
    label.dataset.gps = '17.413800, 104.773400';
  }
}
async function saveRegistration() {
  if (!currentActivityId) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡πà‡∏≠‡∏ô');

  const fullname  = document.getElementById('regFullname').value.trim();
  const studentId = document.getElementById('regStudentId').value.trim();
  const year      = document.getElementById('regYear').value;
  const dept      = document.getElementById('regDept').value;
  const gpsLabel  = document.getElementById('regGPS');
  const gps       = gpsLabel.dataset.gps || null;
  const photoFile = document.getElementById('regPhoto').files[0];
  const photoDataUrl = await fileToDataURL(photoFile);

  if (!fullname || !studentId || !year || !dept)
    return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');

  // ensure array ‡∏Å‡πà‡∏≠‡∏ô push
  registrationsData[currentActivityId] = registrationsData[currentActivityId] || [];
  const regs = registrationsData[currentActivityId];
  const cap  = activitiesData[currentActivityId]?.capacity || 0;
  if (regs.length >= cap) return alert('‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß');

  const reg = {
    fullname, studentId, year, dept,
    gps: gps || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
    photoDataUrl: photoDataUrl || null,
    ts: new Date().toISOString()
  };

  regs.push(reg);
  saveToLocalStorage();
  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  cancelRegistration();
  loadActivitiesPage();
}
function cancelRegistration() {
  currentActivityId = null;
  document.getElementById('registrationBox').classList.add('hidden');
}

// ========= 14) INIT =========
function initializeData() {
  const loaded = loadFromLocalStorage();
  if (!loaded) {
    studentsData = {
      'accounting-1': [
        { id: '653070310202', name: '‡∏ô.‡∏™.‡∏à‡∏∏‡∏ë‡∏≤‡∏°‡∏≤‡∏® ‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≥', photo: 'üë©‚Äçüéì' },
        { id: '653070310012', name: '‡∏ô.‡∏™.‡∏®‡∏∏‡∏†‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå ‡∏™‡∏µ‡∏´‡∏≤', photo: 'üë©‚Äçüéì' }
      ],
      'accounting-2': [
        { id: '653070320101', name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', photo: 'üë®‚Äçüéì' },
        { id: '653070320102', name: '‡∏ô.‡∏™.‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', photo: 'üë©‚Äçüéì' }
      ],
      'management-1': [
        { id: '653070410101', name: '‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏≤‡∏Å‡∏£ ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', photo: 'üë®‚Äçüéì' },
        { id: '653070410102', name: '‡∏ô.‡∏™.‡∏ß‡∏¥‡∏†‡∏≤‡∏î‡∏≤ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', photo: 'üë©‚Äçüéì' }
      ],
      'it-1': [
        { id: '653070510101', name: '‡∏ô‡∏≤‡∏¢‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° ‡πÄ‡∏°‡∏≠‡∏£‡πå', photo: 'üë®‚Äçüíª' },
        { id: '653070510102', name: '‡∏ô.‡∏™.‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå', photo: 'üë©‚Äçüíª' }
      ]
    };
    attendanceData = {};
    behaviorNotes  = {};
    activitiesData = {};
    registrationsData = {};
    saveToLocalStorage();
  }
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('attendanceDate').value = today;
  document.getElementById('reportDate').value     = today;
  document.getElementById('behaviorDate').value   = today;
}

document.addEventListener('DOMContentLoaded', function () {
  initializeData();
  getLocation();
  loadGoogleSheetsConfig();
});
</script>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>MITCheck ‚Äî Student</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--purple:#6213a9;--gold:#fac903}
    *{box-sizing:border-box;font-family:'Sarabun',system-ui,Arial}
    body{background:linear-gradient(180deg,#f5f7ff,#eef2ff)}
    .shadow-soft{box-shadow:0 12px 28px rgba(0,0,0,.12)}
    .status-present{background:#16a34a!important;color:#fff!important}
    .status-absent{background:#dc2626!important;color:#fff!important}
    .status-gps{background:#6d28d9!important;color:#fff!important}
    .navbtn{border-radius:.75rem;padding:.5rem .9rem}
    .navbtn.active{filter:brightness(.95);outline:2px solid #111827}
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-soft p-6 border-t-4" style="border-color:var(--purple)">
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold" style="color:var(--purple)">üéì MITCheck ‚Äì Student</h1>
        <p class="text-gray-700">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏ß‡∏¢ GPS (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤)</p>
        <p class="text-sm text-gray-500">‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏° - ‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</p>
      </div>
      <div class="mt-4 flex flex-wrap justify-center gap-2">
        <button class="navbtn bg-green-600 text-white" data-page="profile">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
        <button class="navbtn" style="background:var(--purple);color:#fff" data-page="departments">üè´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</button>
        <button class="navbtn bg-pink-600 text-white" data-page="activity">üéüÔ∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏¢‡∏®.</button>
      </div>
    </div>

    <!-- GPS banner -->
    <div id="gpsStatus" class="bg-yellow-100 border-l-4 border-yellow-500 p-3 mt-4 rounded hidden">
      <span class="text-yellow-800">üåç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...</span>
    </div>

    <!-- ============ PAGE: PROFILE ============ -->
    <section id="page-profile" class="mt-6">
      <div class="bg-white rounded-2xl shadow-soft p-6">
        <h2 class="text-xl font-bold mb-4">üë• ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input id="pf_name" class="border rounded-lg px-3 py-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
          <input id="pf_sid"  class="border rounded-lg px-3 py-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
          <select id="pf_dept" class="border rounded-lg px-3 py-2">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
            <option value="accounting">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
            <option value="management">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
            <option value="digital">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
            <option value="it">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
            <option value="sports">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</option>
            <option value="marketing">‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
          </select>
          <select id="pf_year" class="border rounded-lg px-3 py-2">
            <option value="">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option>
            <option value="1">‡∏õ‡∏µ 1</option>
            <option value="2">‡∏õ‡∏µ 2</option>
            <option value="3">‡∏õ‡∏µ 3</option>
            <option value="4">‡∏õ‡∏µ 4</option>
          </select>
          <input id="pf_photo" type="file" accept="image/*" class="border rounded-lg px-3 py-2 md:col-span-2">
        </div>
        <div class="mt-4 flex flex-wrap gap-3">
          <button id="pf_save" class="px-6 py-2 rounded-lg text-white" style="background:var(--purple)">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Sheets</button>
        </div>
        <p id="pf_status" class="mt-3 text-sm text-gray-600"></p>
      </div>
    </section>

    <!-- ============ PAGE: DEPARTMENTS ============ -->
    <section id="page-departments" class="mt-6 hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="bg-white rounded-2xl shadow-soft p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">üìä ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border rounded-lg px-3 py-2" onchange="if(this.value){showCheckIn('accounting',this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option><option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option><option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">üíº ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border rounded-lg px-3 py-2" onchange="if(this.value){showCheckIn('management',this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option><option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option><option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">üì± ‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border rounded-lg px-3 py-2" onchange="if(this.value){showCheckIn('digital',this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option><option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option><option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">üíª ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</h3>
          <label class="block text_sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border rounded-lg px-3 py-2" onchange="if(this.value){showCheckIn('it',this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option><option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option><option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">‚öΩ ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border rounded-lg px-3 py-2" onchange="if(this.value){showCheckIn('sports',this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option><option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option><option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>

        <div class="bg-white rounded-2xl shadow-soft p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">üéØ ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</h3>
          <label class="block text-sm text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <select class="w-full border rounded-lg px-3 py-2" onchange="if(this.value){showCheckIn('marketing',this.value); this.value='';}">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‚Äî</option><option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option><option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
        </div>
      </div>
    </section>

    <!-- ============ PAGE: CHECK-IN ============ -->
    <section id="page-checkin" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow-soft p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 id="ci_title" class="text-2xl font-bold text-gray-800">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h2>
            <p id="ci_sub" class="text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
          </div>
          <button class="px-4 py-2 rounded-lg bg-gray-600 text-white" onclick="showPage('departments')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
          <input type="date" id="ci_date" class="border rounded-lg px-3 py-2">
        </div>

        <div id="ci_gpsinfo" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
          <span class="text-blue-800">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="ci_loc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</b></span>
        </div>

        <div id="ci_list" class="space-y-3"></div>

        <div class="text-center mt-6 space-y-2">
          <button id="ci_save" class="px-8 py-3 rounded-lg bg-green-600 text-white text-lg font-semibold">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Sheets</button>
        </div>

        <div id="ci_status" class="mt-4 text-sm text-gray-600"></div>
      </div>
    </section>

    <!-- ============ PAGE: ACTIVITY (‡∏Å‡∏¢‡∏®.) ============ -->
    <section id="page-activity" class="mt-6 hidden">
      <div class="bg-white rounded-2xl shadow-soft p-6">
        <h2 class="text-xl font-bold mb-4">üéüÔ∏è ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏¢‡∏®.</h2>

        <div id="activityList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

        <!-- manual/‡∏™‡∏≥‡∏£‡∏≠‡∏á -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <input id="ac_title" class="border rounded-lg px-3 py-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏¢‡∏®.‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤)">
          <input id="ac_sid" class="border rounded-lg px-3 py-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
          <input id="ac_name" class="border rounded-lg px-3 py-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
          <select id="ac_year" class="border rounded-lg px-3 py-2">
            <option value="">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option><option value="1">‡∏õ‡∏µ 1</option><option value="2">‡∏õ‡∏µ 2</option><option value="3">‡∏õ‡∏µ 3</option><option value="4">‡∏õ‡∏µ 4</option>
          </select>
          <select id="ac_dept" class="border rounded-lg px-3 py-2">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
            <option value="accounting">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
            <option value="management">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
            <option value="digital">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
            <option value="it">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
            <option value="sports">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</option>
            <option value="marketing">‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
          </select>
          <input id="ac_photo" type="file" accept="image/*" class="border rounded-lg px-3 py-2 md:col-span-2">
        </div>
        <div class="mt-4 flex gap-3">
          <button id="ac_gps" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">üìç ‡∏î‡∏∂‡∏á GPS</button>
          <span id="ac_gps_label" class="self-center text-sm text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</span>
        </div>
        <div class="mt-5">
          <button id="ac_save_send" class="px-6 py-2 rounded-lg text-white" style="background:var(--purple)">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Sheets</button>
        </div>
        <p id="ac_status" class="mt-3 text-sm text-gray-600"></p>
      </div>
    </section>
  </div>

  <script>
    /* ==================== (A) CONFIG ==================== */
    // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á admin ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
    const DEFAULT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwSF0ndVoU5hJrRw4ea5xGcu6tlUifsn4nXtEoay-xpR3AmWRsfQRSOGa0Hp2pPpEZh/exec";
    const DEFAULT_SHEETS_ID  = "1ST0Pe4mojfQiWQRR589BTXj0mWqfRorMAsJFKWs89Pc";
    const LS_KEY_CFG = 'mitcheck_google_config';

    let googleSheetsConfig = { webAppUrl: DEFAULT_WEBAPP_URL, sheetsId: DEFAULT_SHEETS_ID };
    try {
      const savedCfg = JSON.parse(localStorage.getItem(LS_KEY_CFG) || "{}");
      if (savedCfg.webAppUrl) googleSheetsConfig.webAppUrl = savedCfg.webAppUrl;
      if (savedCfg.sheetsId)  googleSheetsConfig.sheetsId  = savedCfg.sheetsId;
    } catch {}

    /* ==================== (B) helper: safePost ==================== */
    async function safePost(url, payload = {}) {
      const fd = new FormData();
      fd.append('payload', JSON.stringify(payload));
      const res  = await fetch(url, { method: 'POST', body: fd });
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { throw new Error(`HTTP ${res.status} ${res.statusText}: ${text?.slice(0,200)||'(empty)'}`); }
    }
    // ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á records ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π/admin
    async function sendRecordsSafe(records) {
      if (!googleSheetsConfig.webAppUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL');
      const res = await safePost(googleSheetsConfig.webAppUrl, { records });
      if (!res.success) throw new Error(res.error || 'unknown');
      return res;
    }

    /* ==================== STATE ==================== */
    let currentDepartment = "", currentYear = "", currentLocation = null;
    const LS_KEY_PROFILE = "mitcheck_student_profile";
    function makeStudentListFromProfile() {
      const p = JSON.parse(localStorage.getItem(LS_KEY_PROFILE) || "{}");
      if (!p.sid || !p.name) return [];
      return [{ id: p.sid, name: p.name, emoji: 'üë©‚Äçüéì' }];
    }

    /* ==================== NAV ==================== */
    const navButtons = document.querySelectorAll('.navbtn');
    const pages = {
      profile: document.getElementById('page-profile'),
      departments: document.getElementById('page-departments'),
      checkin: document.getElementById('page-checkin'),
      activity: document.getElementById('page-activity'),
    };
    function showPage(key){
      Object.keys(pages).forEach(k => pages[k].classList.toggle('hidden', k!==key));
      navButtons.forEach(b => b.classList.toggle('active', b.dataset.page===key));
      if (key==='departments') getLocation();
    }
    navButtons.forEach(b=> b.addEventListener('click', ()=> showPage(b.dataset.page)));
    showPage('profile');

    /* ==================== GPS ==================== */
    function getLocation() {
      const banner = document.getElementById('gpsStatus');
      banner.classList.remove('hidden');
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            currentLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
            const ciLoc = document.getElementById('ci_loc');
            if (ciLoc) ciLoc.textContent = `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
            banner.classList.add('hidden');
          },
          ()=>{
            currentLocation = { latitude: 17.386701, longitude: 104.788787 }; // demo
            const ciLoc = document.getElementById('ci_loc');
            if (ciLoc) ciLoc.textContent = `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)} (demo)`;
            banner.classList.add('hidden');
          }
        );
      } else {
        currentLocation = { latitude: 17.386701, longitude: 104.788787 };
        banner.classList.add('hidden');
      }
    }

    /* ==================== UTIL ==================== */
    function fileToDataURL(file){
      return new Promise(resolve=>{
        if(!file) return resolve(null);
        const r=new FileReader(); r.onload=e=>resolve(e.target.result); r.readAsDataURL(file);
      });
    }

    /* ==================== PROFILE ==================== */
    const pfName=document.getElementById('pf_name');
    const pfSid =document.getElementById('pf_sid');
    const pfDept=document.getElementById('pf_dept');
    const pfYear=document.getElementById('pf_year');
    const pfPhoto=document.getElementById('pf_photo');
    const pfStatus=document.getElementById('pf_status');

    (function loadProfile(){
      try{
        const p=JSON.parse(localStorage.getItem(LS_KEY_PROFILE)||'{}');
        pfName.value=p.name||''; pfSid.value=p.sid||''; pfDept.value=p.dept||''; pfYear.value=p.year||''; 
      }catch{}
    })();

    document.getElementById('pf_save').onclick = async ()=>{
      const name=pfName.value.trim(), sid=pfSid.value.trim(), dept=pfDept.value, year=pfYear.value;
      if(!name||!sid||!dept||!year){ pfStatus.textContent='‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; return; }
      const photo=await fileToDataURL(pfPhoto.files?.[0]);
      localStorage.setItem(LS_KEY_PROFILE, JSON.stringify({name,sid,dept,year,photoDataUrl:photo||null}));

      const now=new Date();
      const rec=[{
        date: now.toISOString().split('T')[0],
        time: now.toLocaleTimeString('th-TH'),
        studentId: sid,
        studentName: name,
        department: dept,
        year,
        status: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå',
        gps: '-'
      }];

      pfStatus.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      try {
        const d = await sendRecordsSafe(rec);
        pfStatus.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + d.message;
      } catch (err) {
        pfStatus.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      }
      setTimeout(()=>pfStatus.textContent='',4000);
    };

    /* ==================== CHECK-IN ==================== */
    const ciListHolder = document.getElementById('ci_list');
    const ciDateInput  = document.getElementById('ci_date');
    document.getElementById('ci_date').value = new Date().toISOString().split('T')[0];

    function showCheckIn(dept, year){
      currentDepartment=dept; currentYear=year;
      const nameMap={accounting:'‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',management:'‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',digital:'‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',it:'‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®',sports:'‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤',marketing:'‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î'};
      document.getElementById('ci_title').textContent = `‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ${nameMap[dept]||dept} ‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${year}`;
      document.getElementById('ci_sub').textContent   = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
      showPage('checkin');
      getLocation();
      renderStudentRows();
    }

    function renderStudentRows(){
      ciListHolder.innerHTML='';
      const students = makeStudentListFromProfile();
      if(students.length===0){
        ciListHolder.innerHTML = '<div class="text-gray-500">‡πÇ‡∏õ‡∏£‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" ‡∏Å‡πà‡∏≠‡∏ô</div>';
        return;
      }
      students.forEach(s=>{
        const row=document.createElement('div');
        row.id=`st-${s.id}`;
        row.className='bg-gray-50 rounded-lg p-4 border border-gray-200';
        row.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="text-3xl">${s.emoji}</div>
              <div>
                <div class="font-semibold text-gray-800">${s.name}</div>
                <div class="text-sm text-gray-600">${s.id}</div>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="px-3 py-1 rounded text-sm bg-green-600 text-white" onclick="setStatus('${s.id}','present')">‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
              <button class="px-3 py-1 rounded text-sm bg-red-600 text-white"    onclick="setStatus('${s.id}','absent')">‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
              <button class="px-3 py-1 rounded text-sm bg-purple-600 text-white" onclick="setStatus('${s.id}','gps')">üìç ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
            </div>
          </div>`;
        ciListHolder.appendChild(row);
      });
    }

    const attendanceData = {};
    function setStatus(studentId, status){
      document.getElementById(`st-${studentId}`).classList.remove('status-present','status-absent','status-gps');
      document.getElementById(`st-${studentId}`).classList.add(`status-${status}`);
      const date=ciDateInput.value;
      attendanceData[date]=attendanceData[date]||{};
      attendanceData[date][studentId]={ status, timestamp:new Date().toLocaleString('th-TH'), location:currentLocation, department:currentDepartment, year:currentYear };
    }

    document.getElementById('ci_save').onclick = async ()=>{
      const date=ciDateInput.value;
      const day=attendanceData[date]||{};
      const p = JSON.parse(localStorage.getItem(LS_KEY_PROFILE)||'{}');
      const ciStatus=document.getElementById('ci_status');

      if(!p.sid || !p.name){ ciStatus.textContent='‚ùå ‡πÇ‡∏õ‡∏£‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô'; return; }
      if(!day[p.sid]){ ciStatus.textContent='‚ùå ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; return; }

      const st = day[p.sid];
      const gpsText = st.location ? `${st.location.latitude.toFixed(6)}, ${st.location.longitude.toFixed(6)}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      const statusNames={present:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',absent:'‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',gps:'‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î'};
      const rec=[{date, time:new Date().toLocaleTimeString('th-TH'), studentId:p.sid, studentName:p.name, department:st.department, year:st.year, status:statusNames[st.status]||st.status, gps:gpsText}];

      ciStatus.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
      try{
        const d = await sendRecordsSafe(rec);
        ciStatus.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + d.message;
      }catch(err){
        ciStatus.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      }
      setTimeout(()=>ciStatus.textContent='',4000);
    };

    /* ==================== ACTIVITY: Back-end binding ==================== */
    async function fetchActivitiesForStudent() {
      const listBox = document.getElementById('activityList');
      if (!listBox) return;
      listBox.innerHTML = '<div class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...</div>';

      try {
        const data = await safePost(googleSheetsConfig.webAppUrl, { type: 'listactivities' });
        if (!data.success) throw new Error(data.error || 'load failed');

        const items = data.data || [];
        if (!items.length) {
          listBox.innerHTML = '<div class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</div>';
          return;
        }

        listBox.innerHTML = '';
        items.forEach(act => {
          const remaining = Math.max(0, (Number(act.capacity)||0) - (Number(act.registered)||0));
          const card = document.createElement('div');
          card.className = 'bg-white rounded-lg border p-4 flex flex-col';
          card.innerHTML = `
            <div class="flex-1">
              <h4 class="font-semibold text-gray-800">${act.name}</h4>
              <p class="text-sm text-gray-600 mt-1">
                ‡∏£‡∏±‡∏ö: ${act.capacity} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${act.registered||0}
                ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="${remaining>0?'text-green-700':'text-red-700'} font-semibold">${remaining}</span>
              </p>
              <p class="text-xs text-gray-500 mt-1">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(act.createdAt).toLocaleString('th-TH')}</p>
            </div>
            <div class="mt-3 flex gap-2">
              <button ${remaining===0?'disabled':''}
                onclick="selectActivity('${act.id}', '${(act.name||'').replace(/'/g, "\\'")}')"
                class="px-4 py-2 rounded-lg text-white ${remaining===0?'bg-gray-400 cursor-not-allowed':'bg-indigo-600 hover:bg-indigo-700'}">
                üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
              </button>
            </div>`;
          listBox.appendChild(card);
        });
      } catch (err) {
        listBox.innerHTML = `<div class="text-red-600">‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>`;
      }
    }

    function selectActivity(actId, actName) {
      const boxId = 'registrationBoxStudent';
      let box = document.getElementById(boxId);
      if (!box) {
        const container = document.getElementById('page-activity');
        const el = document.createElement('div');
        el.id = boxId;
        el.className = 'mt-6 bg-indigo-50 border border-indigo-200 rounded-lg p-6';
        el.innerHTML = `
          <h3 class="text-lg font-semibold mb-4">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: <span id="regActTitleStu" class="font-bold"></span></h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="regFullnameStu" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="border border-gray-300 rounded-lg px-3 py-2">
            <input id="regStudentIdStu" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤" class="border border-gray-300 rounded-lg px-3 py-2">
            <select id="regYearStu" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option>
              <option value="1">‡∏õ‡∏µ 1</option>
              <option value="2">‡∏õ‡∏µ 2</option>
              <option value="3">‡∏õ‡∏µ 3</option>
              <option value="4">‡∏õ‡∏µ 4</option>
            </select>
            <select id="regDeptStu" class="border border-gray-300 rounded-lg px-3 py-2">
              <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
              <option value="accounting">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
              <option value="management">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
              <option value="digital">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
              <option value="it">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
              <option value="sports">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏µ‡∏¨‡∏≤</option>
              <option value="marketing">‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
            </select>
          </div>
          <div class="mt-4 flex flex-wrap gap-3">
            <button onclick="captureGPSForRegistrationStu()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">üìç ‡∏î‡∏∂‡∏á GPS</button>
            <span id="regGPSStu" class="text-sm text-gray-700 self-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</span>
          </div>
          <div class="mt-6">
            <button id="btnSaveRegStu" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Sheets</button>
            <button onclick="document.getElementById('${boxId}').remove()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 ml-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>`;
        container.appendChild(el);
        box = el;
      }

      const p = JSON.parse(localStorage.getItem('mitcheck_student_profile') || '{}');
      document.getElementById('regActTitleStu').textContent = actName || '';
      document.getElementById('regFullnameStu').value = p.name || '';
      document.getElementById('regStudentIdStu').value = p.sid || '';
      document.getElementById('regYearStu').value = p.year || '';
      document.getElementById('regDeptStu').value = p.dept || '';

      const btn = document.getElementById('btnSaveRegStu');
      btn.onclick = () => saveRegistrationStu(actId);
    }

    function captureGPSForRegistrationStu() {
      const label = document.getElementById('regGPSStu');
      label.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude.toFixed(6);
            const lng = pos.coords.longitude.toFixed(6);
            label.textContent = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat}, ${lng}`;
            label.dataset.gps = `${lat}, ${lng}`;
          },
          () => {
            label.textContent = '‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ demo: 17.4138, 104.7734)';
            label.dataset.gps = '17.413800, 104.773400';
          },
          { enableHighAccuracy:true, timeout:8000 }
        );
      } else {
        label.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS (demo)';
        label.dataset.gps = '17.413800, 104.773400';
      }
    }

    async function saveRegistrationStu(actId) {
      const fullname  = document.getElementById('regFullnameStu').value.trim();
      const studentId = document.getElementById('regStudentIdStu').value.trim();
      const year      = document.getElementById('regYearStu').value;
      const dept      = document.getElementById('regDeptStu').value;
      const gps       = (document.getElementById('regGPSStu').dataset.gps || '').trim();

      if (!fullname || !studentId || !year || !dept) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
      if (!googleSheetsConfig.webAppUrl) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL'); return; }

      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
      document.body.appendChild(toast);

      try {
        const res = await safePost(googleSheetsConfig.webAppUrl, {
          type: 'register', actId, studentId, fullname, year, dept, gps
        });
        toast.remove();
        if (!res.success) throw new Error(res.error || 'register failed');

        const ok = document.createElement('div');
        ok.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        ok.innerHTML = `<div class="text-center"><div class="text-2xl mb-1">üéâ</div><div class="font-bold">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div><div class="text-sm mt-1">${res.message||''}</div></div>`;
        document.body.appendChild(ok);
        setTimeout(()=>ok.remove(), 5000);

        const box = document.getElementById('registrationBoxStudent'); if (box) box.remove();
        fetchActivitiesForStudent();
      } catch (err) {
        toast.remove();
        const bad = document.createElement('div');
        bad.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        bad.innerHTML = `<div class="text-center"><div class="text-2xl mb-1">‚ùå</div><div class="font-bold">‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div><div class="text-sm mt-1">${err.message}</div></div>`;
        document.body.appendChild(bad);
        setTimeout(()=>bad.remove(), 7000);
      }
    }

    // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î
    const _origShowPage = showPage;
    showPage = function(key) {
      _origShowPage(key);
      if (key === 'activity') fetchActivitiesForStudent();
    };

    /* ==================== ACTIVITY (manual/backup) ==================== */
    const acTitle=document.getElementById('ac_title');
    const acSid=document.getElementById('ac_sid');
    const acName=document.getElementById('ac_name');
    const acYear=document.getElementById('ac_year');
    const acDept=document.getElementById('ac_dept');
    const acPhoto=document.getElementById('ac_photo');
    const acGpsBtn=document.getElementById('ac_gps');
    const acGpsLabel=document.getElementById('ac_gps_label');
    const acStatus=document.getElementById('ac_status');

    (function(){
      const p = JSON.parse(localStorage.getItem(LS_KEY_PROFILE)||'{}');
      if(p.sid) acSid.value=p.sid;
      if(p.name) acName.value=p.name;
      if(p.dept) acDept.value=p.dept;
      if(p.year) acYear.value=p.year;
    })();

    acGpsBtn.onclick = ()=>{
      acGpsLabel.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...';
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          pos=>{ const lat=pos.coords.latitude.toFixed(6), lng=pos.coords.longitude.toFixed(6); acGpsLabel.textContent=`‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat}, ${lng}`; acGpsLabel.dataset.gps=`${lat}, ${lng}`; },
          ()=>{ acGpsLabel.textContent='‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÉ‡∏ä‡πâ demo: 17.4138, 104.7734)'; acGpsLabel.dataset.gps='17.413800, 104.773400'; },
          {enableHighAccuracy:true, timeout:8000}
        );
      }else{
        acGpsLabel.textContent='‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS (demo)'; acGpsLabel.dataset.gps='17.413800, 104.773400';
      }
    };

    document.getElementById('ac_save_send').onclick = async ()=>{
      const title=acTitle.value.trim(), sid=acSid.value.trim(), name=acName.value.trim(), year=acYear.value, dept=acDept.value;
      if(!title||!sid||!name||!year||!dept){ acStatus.textContent='‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; return; }
      const gps = acGpsLabel.dataset.gps || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      const photoDataUrl = await fileToDataURL(acPhoto.files?.[0]); // ‡πÄ‡∏Å‡πá‡∏ö local ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á

      const cache = JSON.parse(localStorage.getItem('mitcheck_activity_regs')||'[]');
      cache.push({title,sid,name,dept,year,gps,photoDataUrl,ts:Date.now()});
      localStorage.setItem('mitcheck_activity_regs', JSON.stringify(cache));

      const now=new Date();
      const records=[{
        date: now.toISOString().split('T')[0],
        time: now.toLocaleTimeString('th-TH'),
        studentId: sid,
        studentName: name,
        department: dept,
        year,
        status: `‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${title}`,
        gps
      }];

      acStatus.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
      try{
        const d = await sendRecordsSafe(records);
        acStatus.textContent = '‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + d.message;
        acTitle.value=''; acPhoto.value=''; acGpsLabel.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î'; delete acGpsLabel.dataset.gps;
      }catch(err){
        acStatus.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      }
      setTimeout(()=>acStatus.textContent='',4000);
    };
  </script>
</body>
</html>
